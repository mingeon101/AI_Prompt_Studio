<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PromptStudio AI</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">

<!-- Firebase ì„¤ì • (ì´ë¯¸ ì…ë ¥ëœ ë³¸ì¸ ê°’) -->
<script>
window.FIREBASE_CONFIG = {
  apiKey:            "AIzaSyChsSo0Zbw_0-Ej3NixxDoJuO36qoBhtR8",
  authDomain:        "ai-prompt-studio-342ad.firebaseapp.com",
  projectId:         "ai-prompt-studio-342ad",
  storageBucket:     "ai-prompt-studio-342ad.firebasestorage.app",
  messagingSenderId: "730861809784",
  appId:             "1:730861809784:web:c0dee12bdaa318575cbd8d",
  measurementId:     "G-ZP5SFBGQ5V"
};
</script>

<style>
:root{--bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;--border:rgba(255,255,255,.07);--accent:#7c6dfa;--accent2:#fa6dbc;--accent3:#6dfabc;--text:#f0f0ff;--text-muted:#8888aa;--glow:rgba(124,109,250,.3);--danger:#fa6d6d;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 60% 50% at 10% 20%,rgba(124,109,250,.12) 0%,transparent 60%),
             radial-gradient(ellipse 40% 60% at 90% 80%,rgba(250,109,188,.08) 0%,transparent 60%);}

/* LOADING */
#loading-overlay{position:fixed;inset:0;z-index:500;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.load-logo{width:56px;height:56px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:26px;animation:pulse 1.5s ease-in-out infinite;}
#loading-overlay p{color:var(--text-muted);font-size:14px;}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;background:var(--bg);}
#login-screen.show{display:flex;}
#login-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 70% 60% at 20% 30%,rgba(124,109,250,.18) 0%,transparent 60%),radial-gradient(ellipse 50% 70% at 80% 70%,rgba(250,109,188,.12) 0%,transparent 60%);}
.login-card{position:relative;z-index:1;background:var(--surface);border:1px solid rgba(124,109,250,.25);border-radius:28px;padding:52px 44px;width:90%;max-width:420px;text-align:center;box-shadow:0 0 100px rgba(124,109,250,.18);animation:scaleIn .4s ease;}
.login-logo{width:64px;height:64px;margin:0 auto 24px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:30px;}
.login-card h1{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;margin-bottom:10px;background:linear-gradient(135deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.login-card .tagline{color:var(--text-muted);font-size:14px;line-height:1.7;margin-bottom:36px;}
.google-btn{width:100%;padding:15px 20px;background:#fff;border:none;border-radius:14px;display:flex;align-items:center;justify-content:center;gap:12px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:500;color:#1f1f1f;cursor:pointer;transition:all .2s;box-shadow:0 2px 16px rgba(0,0,0,.35);}
.google-btn:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,0,0,.45);}
.google-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
.google-btn svg{width:20px;height:20px;flex-shrink:0;}
.login-note{margin-top:22px;font-size:12px;color:var(--text-muted);line-height:1.6;}
.login-note a{color:var(--accent);text-decoration:none;}
.login-err{margin-top:16px;padding:12px 14px;background:rgba(250,109,109,.1);border:1px solid rgba(250,109,109,.3);border-radius:10px;font-size:12px;color:var(--danger);line-height:1.7;display:none;white-space:pre-line;}
.login-err.show{display:block;}

/* API KEY SETUP */
#apikey-screen{position:fixed;inset:0;z-index:290;display:none;align-items:center;justify-content:center;background:rgba(10,10,15,.96);backdrop-filter:blur(8px);}
#apikey-screen.show{display:flex;}
.apikey-card{background:var(--surface);border:1px solid rgba(124,109,250,.2);border-radius:24px;padding:40px;width:90%;max-width:480px;animation:scaleIn .3s ease;}
.apikey-card h2{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;margin-bottom:8px;}
.apikey-card .sub{color:var(--text-muted);font-size:13px;line-height:1.7;margin-bottom:20px;}
.apikey-card .sub a{color:var(--accent);text-decoration:none;}
.ak-steps{margin:0 0 20px;padding:16px;background:var(--surface2);border-radius:12px;font-size:12px;line-height:1.9;color:var(--text-muted);}
.ak-steps b{color:var(--text);}
.ak-input{width:100%;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;margin-bottom:12px;}
.ak-input:focus{border-color:var(--accent);}
.ak-input::placeholder{color:var(--text-muted);}
.ak-save-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:15px;cursor:pointer;transition:all .2s;}
.ak-save-btn:hover{opacity:.85;transform:translateY(-1px);}
.ak-save-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.ak-skip{width:100%;margin-top:10px;padding:10px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all .2s;}
.ak-skip:hover{border-color:var(--accent);color:var(--text);}

/* CHANGE API MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:400;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;width:90%;max-width:440px;animation:scaleIn .25s ease;}
.modal h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:8px;}
.modal p{color:var(--text-muted);font-size:13px;margin-bottom:20px;line-height:1.6;}
.modal-input{width:100%;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif;outline:none;margin-bottom:12px;transition:border-color .2s;}
.modal-input:focus{border-color:var(--accent);}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;}
.modal-cancel{padding:9px 18px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--text-muted);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;}
.modal-ok{padding:9px 18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Syne',sans-serif;font-weight:600;font-size:14px;}

/* APP */
#app{display:none;height:100vh;position:relative;z-index:1;}
#app.show{display:flex;}

/* SIDEBAR */
.sidebar{width:260px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.logo{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;background:linear-gradient(135deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.sidebar-nav{flex:1;padding:12px 10px;overflow-y:auto;}
.nav-section-title{font-size:10px;text-transform:uppercase;letter-spacing:.15em;color:var(--text-muted);padding:8px 10px 4px;font-weight:500;}
.nav-btn{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;border:none;background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;transition:all .2s;text-align:left;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:rgba(124,109,250,.15);color:var(--accent);}
.nav-btn .icon{font-size:16px;width:20px;text-align:center;}
.chat-history-item{width:100%;display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:none;background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;transition:all .2s;text-align:left;}
.chat-history-item:hover{background:var(--surface2);color:var(--text);}
.chat-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* SIDEBAR API STATUS */
.sidebar-api{padding:0 12px 8px;}
.api-status-row{display:flex;align-items:center;gap:7px;padding:8px 12px;border-radius:8px;background:var(--surface2);}
.api-dot{width:7px;height:7px;border-radius:50%;background:#444;flex-shrink:0;}
.api-dot.ok{background:var(--accent3);}
.api-status-text{font-size:11px;color:var(--text-muted);flex:1;}
.api-status-text.ok{color:var(--accent3);}
.api-edit-btn{font-size:11px;color:var(--accent);background:none;border:none;cursor:pointer;padding:2px 4px;}
.api-edit-btn:hover{text-decoration:underline;}

/* MODEL SELECT */
.sidebar-model{padding:0 12px 10px;}
.model-select{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238888aa'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
.model-select:focus{border-color:var(--accent);}

/* SIDEBAR USER */
.sidebar-user{padding:12px;border-top:1px solid var(--border);}
.user-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;background:var(--surface2);}
.user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;overflow:hidden;flex-shrink:0;}
.user-avatar img{width:100%;height:100%;object-fit:cover;}
.user-meta{flex:1;min-width:0;}
.user-name{font-size:13px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-email{font-size:11px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.logout-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:15px;padding:4px;border-radius:6px;transition:color .2s;flex-shrink:0;}
.logout-btn:hover{color:var(--danger);}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:rgba(10,10,15,.85);backdrop-filter:blur(10px);}
.topbar-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;}
.badge{padding:3px 8px;border-radius:20px;font-size:11px;font-weight:500;background:rgba(124,109,250,.15);color:var(--accent);border:1px solid rgba(124,109,250,.3);}
.topbar-actions{margin-left:auto;display:flex;gap:8px;}
.icon-btn{width:34px;height:34px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s;}
.icon-btn:hover{color:var(--text);border-color:var(--accent);}

/* VIEWS */
.view{display:none;flex:1;flex-direction:column;overflow:hidden;}
.view.active{display:flex;}

/* PROMPT VIEW */
.prompt-view-inner{flex:1;overflow-y:auto;padding:32px 40px;}
.prompt-hero{text-align:center;margin-bottom:36px;animation:fadeUp .6s ease both;}
.prompt-hero h1{font-family:'Syne',sans-serif;font-size:clamp(26px,4vw,40px);font-weight:800;line-height:1.15;margin-bottom:12px;}
.gradient-text{background:linear-gradient(90deg,var(--accent) 0%,var(--accent2) 50%,var(--accent3) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.prompt-hero p{color:var(--text-muted);font-size:15px;max-width:500px;margin:0 auto;line-height:1.6;}
.category-scroll{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;justify-content:center;}
.cat-pill{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:13px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;}
.cat-pill:hover{border-color:var(--accent);color:var(--accent);}
.cat-pill.active{background:rgba(124,109,250,.2);border-color:var(--accent);color:var(--text);}
.input-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:24px;animation:fadeUp .6s .1s ease both;}
.input-card textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;resize:none;min-height:80px;line-height:1.7;}
.input-card textarea::placeholder{color:var(--text-muted);}
.input-actions{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.gen-btn{margin-left:auto;padding:9px 20px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-family:'Syne',sans-serif;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;}
.gen-btn:hover{opacity:.85;transform:translateY(-1px);box-shadow:0 4px 20px var(--glow);}
.gen-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.attach-btn{padding:7px 12px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-size:13px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:5px;}
.attach-btn:hover{border-color:var(--accent);color:var(--text);}
.results-grid{display:grid;grid-template-columns:1fr;gap:16px;animation:fadeUp .4s ease both;}
.result-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;transition:border-color .2s;}
.result-card:hover{border-color:rgba(124,109,250,.4);}
.result-label{font-size:11px;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);font-weight:600;margin-bottom:10px;}
.result-text{font-size:14px;line-height:1.75;color:var(--text);white-space:pre-wrap;}
.result-actions{display:flex;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);}
.r-btn{padding:6px 12px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:4px;}
.r-btn:hover{background:var(--surface2);color:var(--text);}
.r-btn.use-btn{background:rgba(124,109,250,.15);color:var(--accent);border-color:rgba(124,109,250,.3);}
.r-btn.use-btn:hover{background:rgba(124,109,250,.25);}

/* CHAT VIEW */
.chat-messages{flex:1;overflow-y:auto;padding:24px 40px;display:flex;flex-direction:column;gap:16px;}
.chat-welcome{text-align:center;padding:60px 20px;color:var(--text-muted);}
.chat-welcome h2{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;margin-bottom:10px;color:var(--text);}
.quick-prompts{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:24px;}
.qp-btn{padding:8px 16px;background:var(--surface);border:1px solid var(--border);border-radius:20px;color:var(--text-muted);font-size:13px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;}
.qp-btn:hover{border-color:var(--accent);color:var(--text);background:rgba(124,109,250,.1);}
.msg{display:flex;gap:12px;animation:fadeUp .3s ease;max-width:800px;}
.msg.user{flex-direction:row-reverse;align-self:flex-end;}
.msg.assistant{align-self:flex-start;}
.msg-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;overflow:hidden;font-weight:700;}
.msg.user .msg-avatar{background:linear-gradient(135deg,var(--accent),var(--accent2));}
.msg.assistant .msg-avatar{background:var(--surface2);border:1px solid var(--border);font-size:14px;}
.msg.user .msg-avatar img{width:100%;height:100%;object-fit:cover;}
.msg-bubble{padding:12px 16px;border-radius:14px;font-size:14px;line-height:1.7;max-width:600px;}
.msg.user .msg-bubble{background:linear-gradient(135deg,rgba(124,109,250,.25),rgba(250,109,188,.15));border:1px solid rgba(124,109,250,.3);border-top-right-radius:4px;}
.msg.assistant .msg-bubble{background:var(--surface);border:1px solid var(--border);border-top-left-radius:4px;}
.typing-dots span{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;margin:0 2px;animation:dot 1.4s infinite;}
.typing-dots span:nth-child(2){animation-delay:.2s;}
.typing-dots span:nth-child(3){animation-delay:.4s;}
.chat-input-area{padding:16px 40px 24px;background:var(--bg);}
.chat-input-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:12px 16px;transition:border-color .2s;}
.chat-input-box:focus-within{border-color:rgba(124,109,250,.5);}
.chat-input-top{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;}
.attach-preview{display:flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(124,109,250,.15);border:1px solid rgba(124,109,250,.3);border-radius:8px;font-size:12px;color:var(--accent);}
.attach-preview .rm{cursor:pointer;opacity:.6;}
.attach-preview .rm:hover{opacity:1;}
.chat-textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;resize:none;max-height:150px;line-height:1.6;}
.chat-textarea::placeholder{color:var(--text-muted);}
.chat-input-footer{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);}
.send-btn{margin-left:auto;width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;}
.send-btn:hover{opacity:.85;transform:scale(1.05);}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.recording-indicator{display:none;align-items:center;gap:8px;color:#ff4444;font-size:12px;}
.recording-indicator.active{display:flex;animation:pulse 1s infinite;}
.rec-dot{width:8px;height:8px;background:#ff4444;border-radius:50%;}

/* IMAGE VIEW */
.image-view-inner{flex:1;overflow-y:auto;padding:32px 40px;}
.section-header{display:flex;align-items:center;gap:12px;margin-bottom:24px;}
.section-header h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;}
.imggen-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:600px;margin:0 auto;}
.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:24px;}
.image-placeholder{aspect-ratio:1;background:var(--surface);border:1px dashed var(--border);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-muted);font-size:13px;gap:8px;}
.img-icon{font-size:32px;}
.file-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:rgba(109,250,188,.1);border:1px solid rgba(109,250,188,.3);border-radius:20px;font-size:11px;color:var(--accent3);margin-top:6px;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:10px 20px;font-size:13px;z-index:600;transition:transform .3s ease;pointer-events:none;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
@keyframes dot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.spinner{display:inline-block;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
  <div class="load-logo">âœ¦</div>
  <p>ë¡œë”© ì¤‘...</p>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">âœ¦</div>
    <h1>PromptStudio AI</h1>
    <p class="tagline">ê°„ë‹¨í•œ ì…ë ¥ìœ¼ë¡œ AIë¥¼ ìµœëŒ€ë¡œ í™œìš©í•˜ëŠ”<br>ìµœì í™” í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.<br>ë¡œê·¸ì¸í•˜ë©´ API í‚¤ê°€ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</p>
    <button class="google-btn" id="google-login-btn" onclick="signInWithGoogle()">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
    </button>
    <div class="login-err" id="login-err"></div>
    <p class="login-note">ë¡œê·¸ì¸í•˜ë©´ Gemini API í‚¤ê°€ ê³„ì •ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì–´<br>ë‹¤ìŒ ë°©ë¬¸ ì‹œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
  </div>
</div>

<!-- API KEY SETUP (ì²« ë¡œê·¸ì¸) -->
<div id="apikey-screen">
  <div class="apikey-card">
    <h2>ğŸ”‘ Gemini API í‚¤ ì„¤ì •</h2>
    <p class="sub">ì²˜ìŒ ë¡œê·¸ì¸í•˜ì…¨ì–´ìš”! API í‚¤ë¥¼ ë“±ë¡í•˜ë©´ ì´í›„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
    <div class="ak-steps">
      <b>ë¬´ë£Œ API í‚¤ ë°œê¸‰ ë°©ë²•</b><br>
      1. <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> ì ‘ì† (ë¡œê·¸ì¸)<br>
      2. <b>Get API key â†’ Create API key</b> í´ë¦­<br>
      3. ìƒì„±ëœ í‚¤ ë³µì‚¬ í›„ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°
    </div>
    <input class="ak-input" type="password" id="ak-input" placeholder="AIzaSy..." />
    <button class="ak-save-btn" id="ak-save-btn" onclick="saveApiKeyFirstTime()">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    <button class="ak-skip" onclick="skipApiKey()">ë‚˜ì¤‘ì— ì„¤ì •í• ê²Œìš”</button>
  </div>
</div>

<!-- CHANGE API KEY MODAL -->
<div class="modal-overlay" id="change-apikey-modal">
  <div class="modal">
    <h3>ğŸ”‘ API í‚¤ ë³€ê²½</h3>
    <p>ìƒˆ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì €ì¥ ì¦‰ì‹œ ê³„ì •ì— ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
    <input type="password" class="modal-input" id="change-api-input" placeholder="AIzaSy..." />
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeChangeApiKey()">ì·¨ì†Œ</button>
      <button class="modal-ok" onclick="confirmChangeApiKey()">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- APP -->
<div id="app">
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">âœ¦</div>
      <div class="logo-text">PromptStudio</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-title">ë©”ë‰´</div>
      <button class="nav-btn active" onclick="switchView('prompt')" id="nav-prompt"><span class="icon">âš¡</span>í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°</button>
      <button class="nav-btn" onclick="switchView('chat')" id="nav-chat"><span class="icon">ğŸ’¬</span>AI ì±„íŒ…</button>
      <button class="nav-btn" onclick="switchView('image')" id="nav-image"><span class="icon">ğŸ¨</span>ì´ë¯¸ì§€ ìƒì„±</button>
      <div class="nav-section-title" style="margin-top:16px;">ìµœê·¼ ëŒ€í™”</div>
      <div id="chat-history"></div>
      <button class="nav-btn" onclick="newChat()" style="margin-top:4px;"><span class="icon">ï¼‹</span>ìƒˆ ì±„íŒ…</button>
    </div>
    <div class="sidebar-api">
      <div class="api-status-row">
        <div class="api-dot" id="api-dot"></div>
        <span class="api-status-text" id="api-status-text">API ë¯¸ì„¤ì •</span>
        <button class="api-edit-btn" onclick="openChangeApiKey()">ë³€ê²½</button>
      </div>
    </div>
    <div class="sidebar-model">
      <select class="model-select" id="model-select">
        <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
      </select>
    </div>
    <div class="sidebar-user">
      <div class="user-row">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-meta">
          <div class="user-name" id="user-name">ë¡œë”© ì¤‘...</div>
          <div class="user-email" id="user-email"></div>
        </div>
        <button class="logout-btn" onclick="doSignOut()" title="ë¡œê·¸ì•„ì›ƒ">â</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbar-title">âš¡ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°</div>
      <div class="badge" id="model-badge">Gemini 1.5 Flash</div>
      <div class="topbar-actions">
        <button class="icon-btn" onclick="newChat()" title="ìƒˆ ì±„íŒ…">âœ¦</button>
      </div>
    </div>

    <!-- PROMPT VIEW -->
    <div class="view active" id="view-prompt">
      <div class="prompt-view-inner">
        <div class="prompt-hero">
          <h1>ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼<br><span class="gradient-text">AI ìµœì  í”„ë¡¬í”„íŠ¸</span>ë¡œ</h1>
          <p>ê°„ë‹¨íˆ ì…ë ¥í•˜ë©´, AIë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì •êµí•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì¦‰ì‹œ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
        </div>
        <div class="category-scroll" id="cat-pills"></div>
        <div class="input-card">
          <textarea id="prompt-input" placeholder="ì˜ˆ: íŒŒì´ì¬ìœ¼ë¡œ ì›¹ ìŠ¤í¬ë˜í¼ ë§Œë“œëŠ” ë²•&#10;ì˜ˆ: ë§ˆì¼€íŒ… ì´ë©”ì¼ ë¬¸êµ¬ ì‘ì„±&#10;ì˜ˆ: ì—¬í–‰ ê³„íš ë„ì™€ì¤˜" rows="3"></textarea>
          <div id="attach-list" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
          <div class="input-actions">
            <button class="attach-btn" onclick="document.getElementById('fup').click()">ğŸ“ íŒŒì¼</button>
            <button class="attach-btn" onclick="document.getElementById('iup').click()">ğŸ–¼ ì‚¬ì§„</button>
            <input type="file" id="fup" hidden accept=".txt,.pdf,.doc,.docx,.md" onchange="attachFile(this,'prompt')">
            <input type="file" id="iup" hidden accept="image/*" onchange="attachImage(this,'prompt')">
            <button class="gen-btn" onclick="generatePrompts()" id="gen-btn">âœ¦ í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
          </div>
        </div>
        <div id="prompt-results"></div>
      </div>
    </div>

    <!-- CHAT VIEW -->
    <div class="view" id="view-chat">
      <div class="chat-messages" id="chat-messages">
        <div class="chat-welcome" id="chat-welcome">
          <h2>ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
          <p>Gemini AIì™€ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”.</p>
          <div class="quick-prompts">
            <button class="qp-btn" onclick="quickPrompt('ì½”ë“œ ë¦¬ë·°ë¥¼ í•´ì¤˜')">ğŸ’» ì½”ë“œ ë¦¬ë·°</button>
            <button class="qp-btn" onclick="quickPrompt('ì´ë©”ì¼ ì´ˆì•ˆ ì‘ì„±í•´ì¤˜')">âœ‰ï¸ ì´ë©”ì¼ ì‘ì„±</button>
            <button class="qp-btn" onclick="quickPrompt('ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° ë„ì™€ì¤˜')">ğŸ’¡ ì•„ì´ë””ì–´</button>
            <button class="qp-btn" onclick="quickPrompt('ìš”ì•½í•´ì¤˜')">ğŸ“ ìš”ì•½</button>
            <button class="qp-btn" onclick="quickPrompt('ë²ˆì—­í•´ì¤˜ (í•œì˜/ì˜í•œ)')">ğŸŒ ë²ˆì—­</button>
            <button class="qp-btn" onclick="quickPrompt('ë°ì´í„° ë¶„ì„ ë„ì™€ì¤˜')">ğŸ“Š ë¶„ì„</button>
          </div>
        </div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-box">
          <div class="chat-input-top" id="chat-attachments"></div>
          <textarea class="chat-textarea" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥... (Enter: ì „ì†¡ / Shift+Enter: ì¤„ë°”ê¿ˆ)" rows="1"
            onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
          <div class="chat-input-footer">
            <button class="attach-btn" onclick="document.getElementById('fuc').click()">ğŸ“</button>
            <button class="attach-btn" onclick="document.getElementById('iuc').click()">ğŸ–¼</button>
            <input type="file" id="fuc" hidden accept=".txt,.pdf,.doc,.docx,.md" onchange="attachFile(this,'chat')">
            <input type="file" id="iuc" hidden accept="image/*" onchange="attachImage(this,'chat')">
            <button class="attach-btn" id="voice-btn" onclick="toggleVoice()">ğŸ¤</button>
            <div class="recording-indicator" id="rec-indicator"><div class="rec-dot"></div><span>ë…¹ìŒ ì¤‘...</span></div>
            <button class="send-btn" id="send-btn" onclick="sendMessage()">â¤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- IMAGE VIEW -->
    <div class="view" id="view-image">
      <div class="image-view-inner">
        <div class="section-header">
          <h2>ğŸ¨ ì´ë¯¸ì§€ ìƒì„±</h2>
          <span class="badge">Gemini 2.0</span>
        </div>
        <div class="imggen-card">
          <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px;line-height:1.6;">Gemini 2.0 Flash ëª¨ë¸ì„ ì„ íƒí•˜ë©´ ì´ë¯¸ì§€ ìƒì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          <div class="input-card" style="margin-bottom:16px;">
            <textarea id="image-prompt-input" placeholder="ì˜ˆ: ë¯¸ë˜ë„ì‹œì˜ ìƒˆë²½, ë„¤ì˜¨ ë¶ˆë¹›, ì‚¬ì´ë²„í‘í¬ ìŠ¤íƒ€ì¼" rows="3"
              style="width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;resize:none;line-height:1.7;"></textarea>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
            <button class="cat-pill" onclick="setImageStyle(this,'ì‚¬ì§„ì²˜ëŸ¼ ì‚¬ì‹¤ì ì¸')">ğŸ“· ì‚¬ì‹¤ì </button>
            <button class="cat-pill" onclick="setImageStyle(this,'ì¼ëŸ¬ìŠ¤íŠ¸ ì•„íŠ¸')">ğŸ¨ ì¼ëŸ¬ìŠ¤íŠ¸</button>
            <button class="cat-pill" onclick="setImageStyle(this,'3D ë Œë”ë§')">ğŸ§Š 3D</button>
            <button class="cat-pill" onclick="setImageStyle(this,'ìˆ˜ì±„í™”')">ğŸŒŠ ìˆ˜ì±„í™”</button>
            <button class="cat-pill" onclick="setImageStyle(this,'í”½ì…€ ì•„íŠ¸')">ğŸ‘¾ í”½ì…€ì•„íŠ¸</button>
          </div>
          <button class="gen-btn" style="width:100%;justify-content:center;" onclick="generateImage()">âœ¦ ì´ë¯¸ì§€ ìƒì„±</button>
        </div>
        <div class="image-grid" id="image-results">
          <div class="image-placeholder"><span class="img-icon">ğŸ–¼</span><span>ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp }    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as fbSignOut }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// â”€â”€ Init â”€â”€
const fbApp    = initializeApp(window.FIREBASE_CONFIG);
const auth     = getAuth(fbApp);
const db       = getFirestore(fbApp);
const provider = new GoogleAuthProvider();

// â”€â”€ State â”€â”€
let currentUser = null;
let apiKey = '';
let model  = 'gemini-1.5-flash';
let chatHistory  = [];
let chatSessions = [];
let isRecording  = false;
let recognition  = null;
let promptAtt = {files:[],images:[]};
let chatAtt   = {files:[],images:[]};
let imageStyle = '';

// â”€â”€ Expose to global (for onclick="...") â”€â”€
const G = window;
G.signInWithGoogle    = signInWithGoogle;
G.doSignOut           = doSignOut;
G.saveApiKeyFirstTime = saveApiKeyFirstTime;
G.skipApiKey          = skipApiKey;
G.openChangeApiKey    = openChangeApiKey;
G.closeChangeApiKey   = closeChangeApiKey;
G.confirmChangeApiKey = confirmChangeApiKey;
G.switchView          = switchView;
G.newChat             = newChat;
G.generatePrompts     = generatePrompts;
G.sendMessage         = sendMessage;
G.handleChatKey       = (e)=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} };
G.autoResize          = (el)=>{ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,150)+'px'; };
G.quickPrompt         = (t)=>{ document.getElementById('chat-input').value=t; sendMessage(); };
G.toggleVoice         = toggleVoice;
G.attachFile          = attachFile;
G.attachImage         = attachImage;
G.removeChatAttach    = removeChatAttach;
G.generateImage       = generateImage;
G.setImageStyle       = (btn,s)=>{ document.querySelectorAll('.imggen-card .cat-pill').forEach(p=>p.classList.remove('active')); btn.classList.add('active'); imageStyle=s; };
G.copyText            = (btn,text)=>{ navigator.clipboard.writeText(text).then(()=>{ const o=btn.innerHTML; btn.textContent='âœ“ ë³µì‚¬ë¨'; setTimeout(()=>btn.innerHTML=o,1500); }); };
G.useInChat           = (text)=>{ switchView('chat'); document.getElementById('chat-input').value=text; G.autoResize(document.getElementById('chat-input')); showToast('ì±„íŒ…ì°½ì— í”„ë¡¬í”„íŠ¸ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤'); };
G.showToast           = showToast;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
onAuthStateChanged(auth, async (user) => {
  document.getElementById('loading-overlay').style.display = 'none';
  if (user) {
    currentUser = user;
    await loadUserData(user);
  } else {
    currentUser = null;
    showLoginScreen();
  }
});

async function signInWithGoogle() {
  const btn = document.getElementById('google-login-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="font-size:18px">âŸ³</span>&nbsp; ë¡œê·¸ì¸ ì¤‘...';
  document.getElementById('login-err').classList.remove('show');
  try {
    await signInWithPopup(auth, provider);
  } catch(e) {
    document.getElementById('login-err').textContent = getAuthErrMsg(e.code);
    document.getElementById('login-err').classList.add('show');
    btn.disabled = false;
    btn.innerHTML = `<svg viewBox="0 0 24 24" style="width:20px;height:20px;flex-shrink:0"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°`;
  }
}

async function doSignOut() {
  if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fbSignOut(auth);
  apiKey = ''; chatHistory = []; chatSessions = [];
  document.getElementById('app').classList.remove('show');
  showLoginScreen();
  showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIRESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUserData(user) {
  try {
    const snap = await getDoc(doc(db,'users',user.uid));
    if (snap.exists()) {
      const d = snap.data();
      apiKey       = d.geminiApiKey || '';
      chatSessions = d.chatSessions || [];
      showApp(user);
    } else {
      // ì²« ë¡œê·¸ì¸
      showApp(user);
      document.getElementById('apikey-screen').classList.add('show');
    }
  } catch(e) {
    showApp(user);
    showToast('âš  Firestore ì˜¤ë¥˜: '+e.message);
  }
}

async function saveFS(fields) {
  if (!currentUser) return;
  try { await setDoc(doc(db,'users',currentUser.uid), fields, {merge:true}); }
  catch(e) { showToast('âš  ì €ì¥ ì˜¤ë¥˜: '+e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoginScreen() {
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('app').classList.remove('show');
}

function showApp(user) {
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('app').classList.add('show');

  document.getElementById('user-name').textContent  = user.displayName || 'ì‚¬ìš©ì';
  document.getElementById('user-email').textContent = user.email || '';
  const av = document.getElementById('user-avatar');
  av.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="">` : (user.displayName||'U')[0].toUpperCase();

  updateApiStatusUI();
  setupCategories();
  loadChatHistoryUI();

  const sel = document.getElementById('model-select');
  sel.onchange = function(){ model=this.value; document.getElementById('model-badge').textContent=this.options[this.selectedIndex].text; };
}

// â”€â”€ API KEY â”€â”€
async function saveApiKeyFirstTime() {
  const val = document.getElementById('ak-input').value.trim();
  if (!val) { showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const btn = document.getElementById('ak-save-btn');
  btn.disabled=true; btn.textContent='ì €ì¥ ì¤‘...';
  apiKey = val;
  await saveFS({geminiApiKey: val});
  btn.disabled=false; btn.textContent='ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°';
  document.getElementById('apikey-screen').classList.remove('show');
  updateApiStatusUI();
  showToast('âœ“ API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function skipApiKey() {
  document.getElementById('apikey-screen').classList.remove('show');
  showToast('ì‚¬ì´ë“œë°” í•˜ë‹¨ì—ì„œ API í‚¤ë¥¼ ì–¸ì œë“ ì§€ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
}

function openChangeApiKey() {
  document.getElementById('change-api-input').value='';
  document.getElementById('change-apikey-modal').classList.add('open');
}
function closeChangeApiKey() { document.getElementById('change-apikey-modal').classList.remove('open'); }
async function confirmChangeApiKey() {
  const val = document.getElementById('change-api-input').value.trim();
  if (!val) { showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  apiKey = val;
  await saveFS({geminiApiKey: val});
  closeChangeApiKey();
  updateApiStatusUI();
  showToast('âœ“ API í‚¤ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updateApiStatusUI() {
  const dot  = document.getElementById('api-dot');
  const text = document.getElementById('api-status-text');
  if (apiKey) { dot.classList.add('ok'); text.classList.add('ok'); text.textContent='API ì—°ê²°ë¨'; }
  else { dot.classList.remove('ok'); text.classList.remove('ok'); text.textContent='API ë¯¸ì„¤ì •'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupCategories() {
  const el = document.getElementById('cat-pills');
  if (el.children.length) return;
  ['ğŸ“ ê¸€ì“°ê¸°','ğŸ’» ì½”ë”©','ğŸ¯ ë§ˆì¼€íŒ…','ğŸ“Š ë¶„ì„','ğŸ¨ ì°½ì˜','ğŸŒ ë²ˆì—­','ğŸ“š í•™ìŠµ','ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤','ğŸ”¬ ì—°êµ¬'].forEach((c,i)=>{
    const b=document.createElement('button'); b.className='cat-pill'+(i===0?' active':''); b.textContent=c;
    b.onclick=()=>{ document.querySelectorAll('#cat-pills .cat-pill').forEach(p=>p.classList.remove('active')); b.classList.add('active'); };
    el.appendChild(b);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(n) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+n).classList.add('active');
  document.getElementById('nav-'+n).classList.add('active');
  document.getElementById('topbar-title').textContent = {prompt:'âš¡ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°',chat:'ğŸ’¬ AI ì±„íŒ…',image:'ğŸ¨ ì´ë¯¸ì§€ ìƒì„±'}[n];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEMINI API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callGemini(messages, sys='') {
  if (!apiKey) { showToast('âš  API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return null; }
  const body = {contents: messages.map(m=>({role:m.role==='assistant'?'model':'user', parts:m.parts||[{text:m.content}]}))};
  if (sys) body.systemInstruction = {parts:[{text:sys}]};
  try {
    const res  = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
      {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  } catch(e) { showToast('âŒ '+e.message); return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROMPT GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PSYS = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ AI í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ AIë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ 3ê°€ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.

ê° í”„ë¡¬í”„íŠ¸ëŠ”: ëª…í™•í•œ ì—­í• /í˜ë¥´ì†Œë‚˜, êµ¬ì²´ì  ì§€ì‹œì‚¬í•­, ì¶œë ¥ í˜•ì‹ ëª…ì‹œ, ì˜ˆì‹œ/ì œì•½ì¡°ê±´ í¬í•¨.

í˜•ì‹:
### í”„ë¡¬í”„íŠ¸ 1: [ìœ í˜•ëª…]
[ë‚´ìš©]

### í”„ë¡¬í”„íŠ¸ 2: [ìœ í˜•ëª…]
[ë‚´ìš©]

### í”„ë¡¬í”„íŠ¸ 3: [ìœ í˜•ëª…]
[ë‚´ìš©]`;

async function generatePrompts() {
  const inp = document.getElementById('prompt-input').value.trim();
  if (!inp) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const btn = document.getElementById('gen-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner">âŸ³</span> ìƒì„± ì¤‘...';
  document.getElementById('prompt-results').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted)"><span class="spinner" style="font-size:28px">âŸ³</span><br><br>ìµœì  í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...</div>';
  let res = await callGemini([{role:'user',content:inp}], PSYS);
  if (!res) res = demoPrompts(inp);
  btn.disabled=false; btn.innerHTML='âœ¦ í”„ë¡¬í”„íŠ¸ ìƒì„±';
  renderResults(res);
}

function demoPrompts(inp) {
  return `### í”„ë¡¬í”„íŠ¸ 1: ì „ë¬¸ê°€ í˜ë¥´ì†Œë‚˜\në‹¹ì‹ ì€ "${inp}" ë¶„ì•¼ì˜ 10ë…„ ì´ìƒ ê²½ë ¥ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì „ë¬¸ì ì´ê³  ì‹¤ìš©ì ì¸ ê´€ì ì—ì„œ ë‹¨ê³„ë³„ë¡œ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê° ë‹¨ê³„ë§ˆë‹¤ ì£¼ì˜ì‚¬í•­ê³¼ ì˜ˆì‹œë¥¼ í¬í•¨í•˜ê³  ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n### í”„ë¡¬í”„íŠ¸ 2: êµ¬ì¡°í™” ë¶„ì„\n"${inp}"ì— ëŒ€í•´ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:\n1. í•µì‹¬ ê°œë… (3ì¤„ ìš”ì•½)\n2. ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ\n3. ì£¼ì˜ì‚¬í•­ê³¼ ìì£¼ ë°œìƒí•˜ëŠ” ì‹¤ìˆ˜\n4. ì‹¬í™” í•™ìŠµ ì¶”ì²œ\n\nê° ì„¹ì…˜ì— ì‹¤ì œ ì˜ˆì‹œë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.\n\n### í”„ë¡¬í”„íŠ¸ 3: ëŒ€í™”í˜• ì½”ì¹˜\në‚˜ëŠ” "${inp}"ë¥¼ ì²˜ìŒ ì‹œì‘í•˜ëŠ” ì´ˆë³´ìì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë‹¹ì¥ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  ì•¡ì…˜ ì•„ì´í…œì„ ì œì‹œí•˜ê³ , ìê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`;
}

function renderResults(text) {
  const sections = text.split(/###\s*í”„ë¡¬í”„íŠ¸\s*\d+[:\s]*/g).filter(s=>s.trim());
  const labels   = [...text.matchAll(/###\s*í”„ë¡¬í”„íŠ¸\s*\d+[:\s]*([^\n]+)/g)].map(m=>m[1].trim());
  const el = document.getElementById('prompt-results');
  el.innerHTML = '<div class="results-grid"></div>';
  const grid = el.querySelector('.results-grid');
  sections.forEach((sec,i)=>{
    const card = document.createElement('div');
    card.className='result-card';
    const esc = sec.trim().replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/"/g,'&quot;');
    card.innerHTML = `<div class="result-label">âœ¦ ${labels[i]||'í”„ë¡¬í”„íŠ¸ '+(i+1)}</div><div class="result-text">${sec.trim()}</div><div class="result-actions"><button class="r-btn" onclick="copyText(this,\`${esc}\`)">ğŸ“‹ ë³µì‚¬</button><button class="r-btn use-btn" onclick="useInChat(\`${esc}\`)">ğŸ’¬ ì±„íŒ…ì—ì„œ ì‚¬ìš©</button></div>`;
    grid.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newChat() {
  if (chatHistory.length>0) {
    chatSessions.unshift({id:Date.now(), title:chatHistory[0]?.content?.substring(0,28)+'â€¦'||'ëŒ€í™”', history:[...chatHistory]});
    if(chatSessions.length>10) chatSessions.pop();
    saveFS({chatSessions});
    loadChatHistoryUI();
  }
  chatHistory=[]; chatAtt={files:[],images:[]};
  document.getElementById('chat-messages').innerHTML=`<div class="chat-welcome" id="chat-welcome"><h2>ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2><p>Gemini AIì™€ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”.</p><div class="quick-prompts"><button class="qp-btn" onclick="quickPrompt('ì½”ë“œ ë¦¬ë·°ë¥¼ í•´ì¤˜')">ğŸ’» ì½”ë“œ ë¦¬ë·°</button><button class="qp-btn" onclick="quickPrompt('ì´ë©”ì¼ ì´ˆì•ˆ ì‘ì„±í•´ì¤˜')">âœ‰ï¸ ì´ë©”ì¼ ì‘ì„±</button><button class="qp-btn" onclick="quickPrompt('ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° ë„ì™€ì¤˜')">ğŸ’¡ ì•„ì´ë””ì–´</button><button class="qp-btn" onclick="quickPrompt('ìš”ì•½í•´ì¤˜')">ğŸ“ ìš”ì•½</button><button class="qp-btn" onclick="quickPrompt('ë²ˆì—­í•´ì¤˜ (í•œì˜/ì˜í•œ)')">ğŸŒ ë²ˆì—­</button><button class="qp-btn" onclick="quickPrompt('ë°ì´í„° ë¶„ì„ ë„ì™€ì¤˜')">ğŸ“Š ë¶„ì„</button></div></div>`;
  document.getElementById('chat-attachments').innerHTML='';
}

function loadChatHistoryUI() {
  const el=document.getElementById('chat-history'); el.innerHTML='';
  chatSessions.slice(0,5).forEach(s=>{
    const b=document.createElement('button'); b.className='chat-history-item';
    b.innerHTML=`<span>ğŸ’¬</span><span class="chat-title">${s.title}</span>`;
    b.onclick=()=>{ chatHistory=[...s.history]; document.getElementById('chat-messages').innerHTML=''; chatHistory.forEach(m=>appendMsg(m.role,m.content,false)); switchView('chat'); };
    el.appendChild(b);
  });
}

async function sendMessage() {
  const inp=document.getElementById('chat-input');
  const text=inp.value.trim();
  if(!text&&!chatAtt.images.length&&!chatAtt.files.length) return;
  document.getElementById('chat-welcome')?.remove();
  document.getElementById('send-btn').disabled=true;
  const parts=[]; let disp=text;
  if(text) parts.push({text});
  for(const img of chatAtt.images){ parts.push({inlineData:{mimeType:img.mimeType,data:img.data}}); disp+=(disp?'\n':'')+`ğŸ–¼ [${img.name}]`; }
  for(const f of chatAtt.files){ parts.push({text:`\n\n[íŒŒì¼: ${f.name}]\n${f.content}`}); disp+=(disp?'\n':'')+`ğŸ“„ [${f.name}]`; }
  appendMsg('user',disp);
  chatHistory.push({role:'user',content:disp,parts});
  inp.value=''; inp.style.height='auto';
  chatAtt={files:[],images:[]}; document.getElementById('chat-attachments').innerHTML='';
  const tid=showTyping();
  const msgs=chatHistory.map(m=>({role:m.role,parts:m.parts||[{text:m.content}]}));
  const resp=await callGemini(msgs);
  removeTyping(tid);
  if(resp){ appendMsg('assistant',resp); chatHistory.push({role:'assistant',content:resp,parts:[{text:resp}]}); }
  document.getElementById('send-btn').disabled=false;
  document.getElementById('chat-messages').scrollTop=999999;
}

function appendMsg(role,content,scroll=true){
  const el=document.getElementById('chat-messages');
  const d=document.createElement('div'); d.className=`msg ${role}`;
  const av=role==='user'
    ? (currentUser?.photoURL?`<img src="${currentUser.photoURL}" alt="">`:(currentUser?.displayName||'ë‚˜')[0].toUpperCase())
    : 'âœ¦';
  d.innerHTML=`<div class="msg-avatar">${av}</div><div class="msg-bubble">${fmtMd(content)}</div>`;
  el.appendChild(d); if(scroll) el.scrollTop=999999;
}

function fmtMd(t){ return t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/`([^`]+)`/g,'<code style="background:rgba(255,255,255,.1);padding:2px 6px;border-radius:4px;font-size:.9em">$1</code>').replace(/\n/g,'<br>'); }
function showTyping(){ const el=document.getElementById('chat-messages'); const id='t'+Date.now(); const d=document.createElement('div'); d.className='msg assistant'; d.id=id; d.innerHTML='<div class="msg-avatar">âœ¦</div><div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>'; el.appendChild(d); el.scrollTop=999999; return id; }
function removeTyping(id){ document.getElementById(id)?.remove(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleVoice(){isRecording?stopRec():startRec();}
function startRec(){
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR(); recognition.lang='ko-KR'; recognition.continuous=false; recognition.interimResults=false;
  recognition.onresult=e=>{ const t=e.results[0][0].transcript; const i=document.getElementById('chat-input'); i.value+=(i.value?' ':'')+t; G.autoResize(i); };
  recognition.onend=()=>stopRec(); recognition.onerror=()=>stopRec();
  recognition.start(); isRecording=true;
  document.getElementById('rec-indicator').classList.add('active');
  document.getElementById('voice-btn').textContent='â¹';
}
function stopRec(){ recognition?.stop(); isRecording=false; document.getElementById('rec-indicator').classList.remove('active'); document.getElementById('voice-btn').textContent='ğŸ¤'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE ATTACHMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function attachFile(inp,ctx){
  const f=inp.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=e=>{ const o={name:f.name,content:e.target.result}; if(ctx==='chat'){chatAtt.files.push(o);updateChatAttUI();}else{promptAtt.files.push(o);updatePromptAttUI();} showToast('ğŸ“„ '+f.name+' ì²¨ë¶€ë¨'); };
  r.readAsText(f); inp.value='';
}
function attachImage(inp,ctx){
  const f=inp.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=e=>{ const o={name:f.name,data:e.target.result.split(',')[1],mimeType:f.type}; if(ctx==='chat'){chatAtt.images.push(o);updateChatAttUI();}else{promptAtt.images.push(o);updatePromptAttUI();} showToast('ğŸ–¼ '+f.name+' ì²¨ë¶€ë¨'); };
  r.readAsDataURL(f); inp.value='';
}
function updateChatAttUI(){
  const el=document.getElementById('chat-attachments'); el.innerHTML='';
  [...chatAtt.files,...chatAtt.images].forEach((f,i)=>{ const d=document.createElement('div'); d.className='attach-preview'; d.innerHTML=`${f.name} <span class="rm" onclick="removeChatAttach(${i})">âœ•</span>`; el.appendChild(d); });
}
function updatePromptAttUI(){
  const el=document.getElementById('attach-list'); el.innerHTML='';
  [...promptAtt.files,...promptAtt.images].forEach(f=>{ const s=document.createElement('span'); s.className='file-chip'; s.textContent='ğŸ“ '+f.name; el.appendChild(s); });
}
function removeChatAttach(i){ const all=[...chatAtt.files,...chatAtt.images]; const item=all[i]; chatAtt.files=chatAtt.files.filter(f=>f!==item); chatAtt.images=chatAtt.images.filter(f=>f!==item); updateChatAttUI(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateImage(){
  const p=document.getElementById('image-prompt-input').value.trim();
  if(!p){showToast('ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
  if(!apiKey){showToast('âš  API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');return;}
  showToast('ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
  const full=imageStyle?`${imageStyle}: ${p}`:p;
  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
      {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:full}]}],generationConfig:{responseModalities:['Text','Image']}})});
    const data=await res.json();
    const img=data.candidates?.[0]?.content?.parts?.find(x=>x.inlineData);
    if(img){ document.getElementById('image-results').innerHTML=`<img src="data:${img.inlineData.mimeType};base64,${img.inlineData.data}" style="width:100%;border-radius:12px;border:1px solid var(--border)">`; }
    else { showToast('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨. ì‚¬ì´ë“œë°”ì—ì„œ gemini-2.0-flash ëª¨ë¸ì„ ì„ íƒí•´ë³´ì„¸ìš”.'); }
  }catch(e){showToast('âŒ '+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600); }
function getAuthErrMsg(code){
  return {'auth/popup-closed-by-user':'ë¡œê·¸ì¸ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
          'auth/popup-blocked':'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.',
          'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.',
          'auth/unauthorized-domain':'âš  ì´ ë„ë©”ì¸ì´ Firebaseì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nFirebase ì½˜ì†” â†’ Authentication â†’ Settings â†’ Authorized domainsì—ì„œ\ní˜„ì¬ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.'}[code] || ('ë¡œê·¸ì¸ ì˜¤ë¥˜: '+code);
}
</script>
</body>
</html>
