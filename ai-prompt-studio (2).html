<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PromptStudio AI</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

<script>
window.FIREBASE_CONFIG = {
  apiKey:            "AIzaSyChsSo0Zbw_0-Ej3NixxDoJuO36qoBhtR8",
  authDomain:        "ai-prompt-studio-342ad.firebaseapp.com",
  projectId:         "ai-prompt-studio-342ad",
  storageBucket:     "ai-prompt-studio-342ad.firebasestorage.app",
  messagingSenderId: "730861809784",
  appId:             "1:730861809784:web:c0dee12bdaa318575cbd8d",
  measurementId:     "G-ZP5SFBGQ5V"
};
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1c1c28;
  --surface3: #222230;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --accent: #7c6dfa;
  --accent2: #fa6dbc;
  --accent3: #6dfabc;
  --text: #f0f0ff;
  --text-muted: #8080a0;
  --text-sub: #5a5a78;
  --glow: rgba(124,109,250,0.25);
  --danger: #fa6d6d;
  --sidebar-w: 260px;
  --topbar-h: 56px;
  --bottombar-h: 64px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html, body { height:100%; overflow:hidden; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  overscroll-behavior: none;
}

body::before {
  content:'';
  position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(ellipse 60% 50% at 10% 10%, rgba(124,109,250,0.1) 0%, transparent 55%),
    radial-gradient(ellipse 50% 60% at 90% 85%, rgba(250,109,188,0.07) 0%, transparent 55%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading-overlay {
  position:fixed; inset:0; z-index:999;
  background:var(--bg);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px;
}
.load-logo {
  width:60px; height:60px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:18px;
  display:flex; align-items:center; justify-content:center;
  font-size:28px;
  animation: loadPulse 1.4s ease-in-out infinite;
}
@keyframes loadPulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(0.92);opacity:0.7} }
#loading-overlay p { color:var(--text-muted); font-size:14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen {
  position:fixed; inset:0; z-index:800;
  display:none; align-items:center; justify-content:center;
  background:var(--bg); padding:16px;
}
#login-screen.show { display:flex; }
#login-screen::before {
  content:''; position:absolute; inset:0;
  background:
    radial-gradient(ellipse 80% 60% at 20% 20%, rgba(124,109,250,0.15) 0%, transparent 60%),
    radial-gradient(ellipse 60% 70% at 80% 80%, rgba(250,109,188,0.1) 0%, transparent 60%);
}
.login-card {
  position:relative; z-index:1;
  background:var(--surface);
  border:1px solid rgba(124,109,250,0.2);
  border-radius:28px;
  padding:40px 32px;
  width:100%; max-width:400px;
  text-align:center;
  box-shadow:0 0 80px rgba(124,109,250,0.15);
  animation:scaleIn 0.4s ease;
}
.login-logo {
  width:64px; height:64px; margin:0 auto 22px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:20px;
  display:flex; align-items:center; justify-content:center; font-size:30px;
}
.login-card h1 {
  font-family:'Syne',sans-serif; font-weight:800; font-size:26px; margin-bottom:8px;
  background:linear-gradient(135deg,#fff 40%,var(--accent));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.login-tagline { color:var(--text-muted); font-size:13px; line-height:1.7; margin-bottom:32px; }
.google-btn {
  width:100%; padding:14px 18px;
  background:#fff; border:none; border-radius:14px;
  display:flex; align-items:center; justify-content:center; gap:10px;
  font-family:'DM Sans',sans-serif; font-size:15px; font-weight:500; color:#1f1f1f;
  cursor:pointer; transition:all 0.2s;
  box-shadow:0 2px 14px rgba(0,0,0,0.3);
  -webkit-tap-highlight-color:transparent;
}
.google-btn:hover { transform:translateY(-2px); box-shadow:0 5px 20px rgba(0,0,0,0.4); }
.google-btn:active { transform:translateY(0); }
.google-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
.google-btn svg { width:20px; height:20px; flex-shrink:0; }
.login-note { margin-top:20px; font-size:11px; color:var(--text-sub); line-height:1.6; }
.login-err {
  margin-top:14px; padding:11px 14px;
  background:rgba(250,109,109,0.1); border:1px solid rgba(250,109,109,0.3);
  border-radius:10px; font-size:12px; color:var(--danger); line-height:1.7;
  display:none; white-space:pre-line; text-align:left;
}
.login-err.show { display:block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY SETUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#apikey-screen {
  position:fixed; inset:0; z-index:700;
  display:none; align-items:center; justify-content:center;
  background:rgba(10,10,15,0.95); backdrop-filter:blur(10px);
  padding:16px;
}
#apikey-screen.show { display:flex; }
.apikey-card {
  background:var(--surface);
  border:1px solid rgba(124,109,250,0.2);
  border-radius:24px;
  padding:36px 28px;
  width:100%; max-width:460px;
  animation:scaleIn 0.3s ease;
  max-height:90vh; overflow-y:auto;
}
.apikey-card h2 { font-family:'Syne',sans-serif; font-size:20px; font-weight:700; margin-bottom:6px; }
.apikey-card .sub { color:var(--text-muted); font-size:13px; line-height:1.7; margin-bottom:18px; }
.ak-steps {
  margin:0 0 18px; padding:14px;
  background:var(--surface2); border-radius:12px;
  font-size:12px; line-height:1.9; color:var(--text-muted);
}
.ak-steps b { color:var(--text); }
.ak-steps a { color:var(--accent); text-decoration:none; }
.ak-input {
  width:100%; padding:12px 14px;
  background:var(--bg); border:1px solid var(--border);
  border-radius:10px; color:var(--text);
  font-family:'DM Sans',sans-serif; font-size:14px; outline:none;
  transition:border-color 0.2s; margin-bottom:10px;
  -webkit-appearance:none;
}
.ak-input:focus { border-color:var(--accent); }
.ak-input::placeholder { color:var(--text-muted); }
.ak-save-btn {
  width:100%; padding:14px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none; border-radius:12px; color:#fff;
  font-family:'Syne',sans-serif; font-weight:700; font-size:15px;
  cursor:pointer; transition:all 0.2s;
}
.ak-save-btn:hover { opacity:0.88; transform:translateY(-1px); }
.ak-save-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
.ak-skip {
  width:100%; margin-top:8px; padding:11px;
  background:transparent; border:1px solid var(--border);
  border-radius:12px; color:var(--text-muted);
  font-family:'DM Sans',sans-serif; font-size:13px; cursor:pointer;
  transition:all 0.2s;
}
.ak-skip:hover { border-color:var(--accent); color:var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHANGE API KEY MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.75); backdrop-filter:blur(4px);
  z-index:600; align-items:center; justify-content:center; padding:16px;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--surface); border:1px solid var(--border2);
  border-radius:20px; padding:28px;
  width:100%; max-width:420px;
  animation:scaleIn 0.25s ease;
}
.modal h3 { font-family:'Syne',sans-serif; font-size:17px; font-weight:700; margin-bottom:7px; }
.modal p { color:var(--text-muted); font-size:13px; margin-bottom:18px; line-height:1.6; }
.modal-input {
  width:100%; padding:12px 14px;
  background:var(--bg); border:1px solid var(--border);
  border-radius:10px; color:var(--text);
  font-family:'DM Sans',sans-serif; font-size:14px; outline:none;
  margin-bottom:12px; transition:border-color 0.2s;
  -webkit-appearance:none;
}
.modal-input:focus { border-color:var(--accent); }
.modal-actions { display:flex; gap:10px; justify-content:flex-end; }
.modal-cancel {
  padding:9px 18px; background:transparent;
  border:1px solid var(--border); border-radius:10px;
  color:var(--text-muted); cursor:pointer;
  font-family:'DM Sans',sans-serif; font-size:14px;
}
.modal-ok {
  padding:9px 18px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none; border-radius:10px; color:#fff;
  cursor:pointer; font-family:'Syne',sans-serif; font-weight:600; font-size:14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app { display:none; height:100vh; position:relative; z-index:1; }
#app.show { display:flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR (Desktop & Tablet)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  width:var(--sidebar-w);
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column; flex-shrink:0;
  height:100vh;
  transition:transform 0.3s ease, width 0.3s ease;
  z-index:100;
}

/* Tablet: icon-only sidebar */
@media (min-width:640px) and (max-width:959px) {
  :root { --sidebar-w:64px; }
  .sidebar { overflow:hidden; }
  .logo-text,
  .nav-btn span:not(.icon),
  .nav-section-title,
  .chat-history-item,
  .sidebar-api,
  .sidebar-model,
  .user-meta,
  .logout-btn,
  .sidebar-new-chat-label { display:none !important; }
  .nav-btn { justify-content:center; padding:12px; }
  .nav-btn .icon { width:auto; font-size:20px; }
  .logo { justify-content:center; padding:16px 0; }
  .sidebar-user { padding:10px 0; }
  .user-row { justify-content:center; padding:10px; gap:0; }
  .sidebar-nav { padding:8px 4px; }
}

/* Mobile: hidden sidebar + bottom tabs */
@media (max-width:639px) {
  .sidebar { display:none !important; }
}

.logo {
  padding:16px 18px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px;
  flex-shrink:0;
}
.logo-icon {
  width:34px; height:34px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:10px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:17px;
}
.logo-text {
  font-family:'Syne',sans-serif; font-weight:800; font-size:15px;
  background:linear-gradient(135deg,#fff 40%,var(--accent));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  white-space:nowrap;
}
.sidebar-nav { flex:1; padding:10px 8px; overflow-y:auto; }
.nav-section-title {
  font-size:10px; text-transform:uppercase; letter-spacing:0.15em;
  color:var(--text-sub); padding:8px 10px 4px; font-weight:500;
}
.nav-btn {
  width:100%; display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:10px; border:none;
  background:transparent; color:var(--text-muted);
  font-family:'DM Sans',sans-serif; font-size:13px;
  cursor:pointer; transition:all 0.2s; text-align:left;
}
.nav-btn:hover { background:var(--surface2); color:var(--text); }
.nav-btn.active { background:rgba(124,109,250,0.15); color:var(--accent); }
.nav-btn .icon { font-size:16px; width:20px; text-align:center; flex-shrink:0; }
.chat-history-item {
  width:100%; display:flex; align-items:center; gap:8px;
  padding:7px 12px; border-radius:8px; border:none;
  background:transparent; color:var(--text-muted);
  font-family:'DM Sans',sans-serif; font-size:12px;
  cursor:pointer; transition:all 0.2s; text-align:left;
}
.chat-history-item:hover { background:var(--surface2); color:var(--text); }
.chat-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.sidebar-api {
  padding:0 10px 8px;
}
.api-status-row {
  display:flex; align-items:center; gap:7px;
  padding:8px 10px; border-radius:8px; background:var(--surface2);
}
.api-dot { width:7px; height:7px; border-radius:50%; background:#333; flex-shrink:0; }
.api-dot.ok { background:var(--accent3); }
.api-status-text { font-size:11px; color:var(--text-muted); flex:1; }
.api-status-text.ok { color:var(--accent3); }
.api-edit-btn {
  font-size:11px; color:var(--accent); background:none; border:none;
  cursor:pointer; padding:2px 4px; white-space:nowrap;
}
.sidebar-model { padding:0 10px 10px; }
.model-select {
  width:100%; padding:8px 10px;
  background:var(--bg); border:1px solid var(--border);
  border-radius:8px; color:var(--text);
  font-size:12px; font-family:'DM Sans',sans-serif; outline:none; cursor:pointer;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238888aa'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 10px center;
}
.model-select:focus { border-color:var(--accent); }
.sidebar-user { padding:10px; border-top:1px solid var(--border); flex-shrink:0; }
.user-row {
  display:flex; align-items:center; gap:10px;
  padding:10px 10px; border-radius:10px; background:var(--surface2);
}
.user-avatar {
  width:32px; height:32px; border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex; align-items:center; justify-content:center;
  font-size:13px; font-weight:700; overflow:hidden; flex-shrink:0;
}
.user-avatar img { width:100%; height:100%; object-fit:cover; }
.user-meta { flex:1; min-width:0; }
.user-name { font-size:13px; font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.user-email { font-size:11px; color:var(--text-muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.logout-btn {
  background:none; border:none; color:var(--text-muted);
  cursor:pointer; font-size:16px; padding:4px; border-radius:6px;
  transition:color 0.2s; flex-shrink:0;
}
.logout-btn:hover { color:var(--danger); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main {
  flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  height:var(--topbar-h);
  padding:0 20px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px;
  background:rgba(10,10,15,0.88); backdrop-filter:blur(12px);
  flex-shrink:0; position:relative; z-index:10;
}
.topbar-title {
  font-family:'Syne',sans-serif; font-weight:700; font-size:15px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.badge {
  padding:3px 8px; border-radius:20px; font-size:11px; font-weight:500;
  background:rgba(124,109,250,0.15); color:var(--accent);
  border:1px solid rgba(124,109,250,0.3);
  white-space:nowrap;
}
.topbar-actions { margin-left:auto; display:flex; gap:6px; align-items:center; }
.icon-btn {
  width:34px; height:34px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:9px; color:var(--text-muted); cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:15px;
  transition:all 0.2s; flex-shrink:0;
}
.icon-btn:hover { color:var(--text); border-color:var(--accent); }

/* Mobile topbar user button */
.topbar-user-btn {
  width:32px; height:32px; border-radius:50%; overflow:hidden;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:none; align-items:center; justify-content:center;
  font-size:13px; font-weight:700; cursor:pointer;
  border:2px solid rgba(124,109,250,0.4);
  flex-shrink:0;
}
.topbar-user-btn img { width:100%; height:100%; object-fit:cover; }
@media (max-width:639px) {
  .topbar-user-btn { display:flex; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE USER DRAWER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mobile-drawer {
  position:fixed; inset:0; z-index:500;
  display:none;
}
#mobile-drawer.open { display:block; }
.drawer-backdrop {
  position:absolute; inset:0;
  background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
}
.drawer-panel {
  position:absolute; right:0; top:0; bottom:0; width:280px;
  background:var(--surface);
  border-left:1px solid var(--border);
  display:flex; flex-direction:column;
  animation:slideInRight 0.28s ease;
  overflow-y:auto;
}
@keyframes slideInRight { from{transform:translateX(100%)} to{transform:translateX(0)} }
.drawer-header {
  padding:20px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
}
.drawer-header h3 { font-family:'Syne',sans-serif; font-size:16px; font-weight:700; }
.drawer-close { background:none; border:none; color:var(--text-muted); font-size:20px; cursor:pointer; }
.drawer-section { padding:16px; border-bottom:1px solid var(--border); }
.drawer-section-title { font-size:11px; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-sub); margin-bottom:10px; font-weight:500; }
.drawer-user-row { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
.drawer-avatar { width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; overflow:hidden; flex-shrink:0; }
.drawer-avatar img { width:100%; height:100%; object-fit:cover; }
.drawer-user-name { font-size:14px; font-weight:500; }
.drawer-user-email { font-size:12px; color:var(--text-muted); }
.drawer-api-row { display:flex; align-items:center; gap:8px; padding:10px 12px; background:var(--surface2); border-radius:10px; margin-bottom:8px; }
.drawer-model-select { width:100%; padding:10px 12px; background:var(--bg); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; outline:none; cursor:pointer; appearance:none; -webkit-appearance:none; }
.drawer-btn { width:100%; padding:11px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text-muted); font-family:'DM Sans',sans-serif; font-size:14px; cursor:pointer; transition:all 0.2s; text-align:left; display:flex; align-items:center; gap:10px; margin-bottom:6px; }
.drawer-btn:hover { background:var(--surface2); color:var(--text); }
.drawer-logout { color:var(--danger); border-color:rgba(250,109,109,0.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.views-wrap {
  flex:1; overflow:hidden; position:relative;
}
.view { display:none; height:100%; flex-direction:column; }
.view.active { display:flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROMPT VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scroll-area { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }
.prompt-view-inner { padding:28px 32px; }
@media (max-width:639px) { .prompt-view-inner { padding:20px 16px; } }
@media (min-width:640px) and (max-width:959px) { .prompt-view-inner { padding:24px 20px; } }

.prompt-hero { text-align:center; margin-bottom:28px; animation:fadeUp 0.5s ease both; }
.prompt-hero h1 {
  font-family:'Syne',sans-serif; font-weight:800;
  font-size:clamp(22px, 4vw, 38px);
  line-height:1.2; margin-bottom:10px;
}
.gradient-text {
  background:linear-gradient(90deg,var(--accent) 0%,var(--accent2) 50%,var(--accent3) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.prompt-hero p { color:var(--text-muted); font-size:14px; max-width:480px; margin:0 auto; line-height:1.6; }

.category-scroll {
  display:flex; gap:8px; margin-bottom:18px;
  overflow-x:auto; padding-bottom:4px;
  scrollbar-width:none; -ms-overflow-style:none;
  -webkit-overflow-scrolling:touch;
  justify-content:flex-start;
}
.category-scroll::-webkit-scrollbar { display:none; }
@media (min-width:640px) { .category-scroll { flex-wrap:wrap; justify-content:center; } }

.cat-pill {
  padding:6px 14px; border-radius:20px;
  border:1px solid var(--border); background:transparent;
  color:var(--text-muted); font-size:13px; cursor:pointer;
  transition:all 0.2s; font-family:'DM Sans',sans-serif;
  white-space:nowrap; flex-shrink:0;
}
.cat-pill:hover { border-color:var(--accent); color:var(--accent); }
.cat-pill.active { background:rgba(124,109,250,0.2); border-color:var(--accent); color:var(--text); }

.input-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:16px; padding:18px; margin-bottom:20px;
  animation:fadeUp 0.5s 0.08s ease both;
  transition:border-color 0.2s;
}
.input-card:focus-within { border-color:rgba(124,109,250,0.4); }
.input-card textarea {
  width:100%; background:transparent; border:none; outline:none;
  color:var(--text); font-family:'DM Sans',sans-serif; font-size:15px;
  resize:none; min-height:80px; line-height:1.7;
  -webkit-appearance:none;
}
.input-card textarea::placeholder { color:var(--text-muted); }
.input-actions {
  display:flex; align-items:center; gap:8px;
  margin-top:12px; padding-top:12px;
  border-top:1px solid var(--border);
  flex-wrap:wrap;
}
.attach-btn {
  padding:7px 12px; background:transparent;
  border:1px solid var(--border); border-radius:8px;
  color:var(--text-muted); font-size:12px; cursor:pointer;
  transition:all 0.2s; font-family:'DM Sans',sans-serif;
  display:flex; align-items:center; gap:5px;
  white-space:nowrap;
}
.attach-btn:hover { border-color:var(--accent); color:var(--text); }
.gen-btn {
  margin-left:auto;
  padding:9px 18px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none; border-radius:10px; color:#fff;
  font-family:'Syne',sans-serif; font-weight:600; font-size:14px;
  cursor:pointer; transition:all 0.2s;
  display:flex; align-items:center; gap:6px;
  white-space:nowrap;
}
.gen-btn:hover { opacity:0.85; transform:translateY(-1px); box-shadow:0 4px 18px var(--glow); }
.gen-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

.results-grid { display:grid; grid-template-columns:1fr; gap:14px; }
.result-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:14px; padding:18px; transition:border-color 0.2s;
  animation:fadeUp 0.4s ease both;
}
.result-card:hover { border-color:rgba(124,109,250,0.35); }
.result-label { font-size:10px; text-transform:uppercase; letter-spacing:0.12em; color:var(--accent); font-weight:600; margin-bottom:10px; }
.result-text { font-size:13px; line-height:1.8; color:var(--text); white-space:pre-wrap; }
.result-actions {
  display:flex; gap:8px; margin-top:12px; padding-top:12px;
  border-top:1px solid var(--border); flex-wrap:wrap;
}
.r-btn {
  padding:6px 12px; background:transparent;
  border:1px solid var(--border); border-radius:8px;
  color:var(--text-muted); font-size:12px; cursor:pointer;
  transition:all 0.2s; font-family:'DM Sans',sans-serif;
  display:flex; align-items:center; gap:4px;
}
.r-btn:hover { background:var(--surface2); color:var(--text); }
.r-btn.use-btn { background:rgba(124,109,250,0.15); color:var(--accent); border-color:rgba(124,109,250,0.3); }
.r-btn.use-btn:hover { background:rgba(124,109,250,0.25); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-messages {
  flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;
  padding:20px 32px;
  display:flex; flex-direction:column; gap:14px;
}
@media (max-width:639px) {
  .chat-messages { padding:16px 14px; padding-bottom:10px; }
}
@media (min-width:640px) and (max-width:959px) {
  .chat-messages { padding:16px 20px; }
}
.chat-welcome { text-align:center; padding:48px 20px; color:var(--text-muted); }
.chat-welcome h2 { font-family:'Syne',sans-serif; font-size:20px; font-weight:700; margin-bottom:8px; color:var(--text); }
.chat-welcome p { font-size:13px; line-height:1.6; }
.quick-prompts { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:20px; }
.qp-btn {
  padding:8px 14px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:20px; color:var(--text-muted); font-size:12px;
  cursor:pointer; transition:all 0.2s; font-family:'DM Sans',sans-serif;
}
.qp-btn:hover { border-color:var(--accent); color:var(--text); background:rgba(124,109,250,0.1); }
.qp-btn:active { transform:scale(0.97); }

.msg { display:flex; gap:10px; animation:fadeUp 0.25s ease; }
.msg.user { flex-direction:row-reverse; align-self:flex-end; max-width:85%; }
.msg.assistant { align-self:flex-start; max-width:85%; }
@media (min-width:640px) { .msg.user, .msg.assistant { max-width:70%; } }
.msg-avatar {
  width:30px; height:30px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:700; flex-shrink:0; overflow:hidden;
}
.msg.user .msg-avatar { background:linear-gradient(135deg,var(--accent),var(--accent2)); }
.msg.assistant .msg-avatar { background:var(--surface2); border:1px solid var(--border); font-size:14px; }
.msg.user .msg-avatar img { width:100%; height:100%; object-fit:cover; }
.msg-bubble {
  padding:11px 15px; border-radius:14px;
  font-size:14px; line-height:1.7;
}
@media (max-width:639px) { .msg-bubble { font-size:13px; padding:10px 13px; } }
.msg.user .msg-bubble {
  background:linear-gradient(135deg,rgba(124,109,250,0.22),rgba(250,109,188,0.13));
  border:1px solid rgba(124,109,250,0.28);
  border-top-right-radius:4px;
}
.msg.assistant .msg-bubble {
  background:var(--surface);
  border:1px solid var(--border);
  border-top-left-radius:4px;
}
.typing-dots span {
  display:inline-block; width:6px; height:6px;
  background:var(--accent); border-radius:50%; margin:0 2px;
  animation:dot 1.4s infinite;
}
.typing-dots span:nth-child(2) { animation-delay:0.2s; }
.typing-dots span:nth-child(3) { animation-delay:0.4s; }

/* â”€â”€â”€ CHAT INPUT â”€â”€â”€ */
.chat-input-area {
  padding:12px 24px calc(12px + var(--safe-bottom)) 24px;
  background:var(--bg);
  border-top:1px solid var(--border);
  flex-shrink:0;
}
@media (max-width:639px) {
  .chat-input-area {
    padding:10px 12px calc(var(--bottombar-h) + 10px + var(--safe-bottom)) 12px;
  }
}
@media (min-width:640px) and (max-width:959px) {
  .chat-input-area { padding:12px 16px; }
}
.chat-input-box {
  background:var(--surface); border:1px solid var(--border);
  border-radius:16px; padding:12px 14px;
  transition:border-color 0.2s;
}
.chat-input-box:focus-within { border-color:rgba(124,109,250,0.5); }
.chat-input-top { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
.attach-preview {
  display:flex; align-items:center; gap:5px;
  padding:3px 9px;
  background:rgba(124,109,250,0.15); border:1px solid rgba(124,109,250,0.3);
  border-radius:7px; font-size:11px; color:var(--accent);
}
.attach-preview .rm { cursor:pointer; opacity:0.6; }
.attach-preview .rm:hover { opacity:1; }
.chat-textarea {
  width:100%; background:transparent; border:none; outline:none;
  color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px;
  resize:none; max-height:120px; line-height:1.6;
  -webkit-appearance:none;
}
@media (max-width:639px) { .chat-textarea { font-size:16px; } }/* Prevent zoom on iOS */
.chat-textarea::placeholder { color:var(--text-muted); }
.chat-input-footer {
  display:flex; align-items:center; gap:8px;
  margin-top:10px; padding-top:10px;
  border-top:1px solid var(--border);
}
.send-btn {
  margin-left:auto; width:36px; height:36px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none; border-radius:10px; color:#fff; cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:16px;
  transition:all 0.2s; flex-shrink:0;
}
.send-btn:hover { opacity:0.85; transform:scale(1.05); }
.send-btn:active { transform:scale(0.95); }
.send-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
.recording-indicator { display:none; align-items:center; gap:6px; color:#ff4444; font-size:12px; }
.recording-indicator.active { display:flex; animation:pulse 1s infinite; }
.rec-dot { width:7px; height:7px; background:#ff4444; border-radius:50%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMAGE VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.image-view-inner { padding:28px 32px; }
@media (max-width:639px) { .image-view-inner { padding:20px 16px; } }
@media (min-width:640px) and (max-width:959px) { .image-view-inner { padding:24px 20px; } }
.section-header { display:flex; align-items:center; gap:12px; margin-bottom:22px; }
.section-header h2 { font-family:'Syne',sans-serif; font-size:20px; font-weight:700; }
.imggen-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:16px; padding:22px;
  max-width:560px; margin:0 auto;
}
.image-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:14px; margin-top:22px;
}
.image-placeholder {
  aspect-ratio:1; background:var(--surface);
  border:1px dashed var(--border); border-radius:12px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:var(--text-muted); font-size:13px; gap:8px;
}
.img-icon { font-size:30px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE BOTTOM TAB BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-tabbar {
  display:none;
  position:fixed; bottom:0; left:0; right:0;
  height:calc(var(--bottombar-h) + var(--safe-bottom));
  padding-bottom:var(--safe-bottom);
  background:var(--surface);
  border-top:1px solid var(--border);
  z-index:50;
  align-items:center; justify-content:space-around;
}
@media (max-width:639px) {
  .bottom-tabbar { display:flex; }
  .views-wrap { margin-bottom:0; }
}
.tab-item {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px; padding:8px 4px; cursor:pointer; border:none; background:transparent;
  color:var(--text-sub); transition:color 0.2s;
  -webkit-tap-highlight-color:transparent;
}
.tab-item.active { color:var(--accent); }
.tab-icon { font-size:20px; line-height:1; }
.tab-label { font-size:10px; font-family:'DM Sans',sans-serif; font-weight:500; letter-spacing:0.02em; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLLBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position:fixed; bottom:calc(var(--bottombar-h) + 14px + var(--safe-bottom)); left:50%;
  transform:translateX(-50%) translateY(20px);
  background:var(--surface2); border:1px solid var(--border2);
  border-radius:12px; padding:10px 18px; font-size:13px;
  z-index:700; transition:all 0.3s ease;
  pointer-events:none; white-space:nowrap; opacity:0;
}
.toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
@media (min-width:640px) { .toast { bottom:20px; } }

/* file chip */
.file-chip {
  display:inline-flex; align-items:center; gap:5px;
  padding:3px 10px;
  background:rgba(109,250,188,0.1); border:1px solid rgba(109,250,188,0.3);
  border-radius:20px; font-size:11px; color:var(--accent3); margin-top:6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
@keyframes scaleIn { from{opacity:0;transform:scale(0.93)} to{opacity:1;transform:scale(1)} }
@keyframes dot { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.spinner { display:inline-block; animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
  <div class="load-logo">âœ¦</div>
  <p>ë¡œë”© ì¤‘...</p>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">âœ¦</div>
    <h1>PromptStudio AI</h1>
    <p class="login-tagline">ê°„ë‹¨í•œ ì…ë ¥ìœ¼ë¡œ AIë¥¼ ìµœëŒ€ë¡œ í™œìš©í•˜ëŠ”<br>ìµœì í™” í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.<br>ë¡œê·¸ì¸í•˜ë©´ API í‚¤ê°€ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</p>
    <button class="google-btn" id="google-login-btn" onclick="signInWithGoogle()">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
    </button>
    <div class="login-err" id="login-err"></div>
    <p class="login-note">ë¡œê·¸ì¸í•˜ë©´ API í‚¤ê°€ ê³„ì •ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì–´<br>ë‹¤ìŒ ë°©ë¬¸ ì‹œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
  </div>
</div>

<!-- API KEY SETUP -->
<div id="apikey-screen">
  <div class="apikey-card">
    <h2>ğŸ”‘ Gemini API í‚¤ ì„¤ì •</h2>
    <p class="sub">ì²˜ìŒ ë¡œê·¸ì¸í•˜ì…¨ì–´ìš”! API í‚¤ë¥¼ ë“±ë¡í•˜ë©´ ì´í›„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
    <div class="ak-steps">
      <b>ë¬´ë£Œ API í‚¤ ë°œê¸‰ ë°©ë²•</b><br>
      1. <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> ì ‘ì†<br>
      2. <b>Get API key â†’ Create API key</b> í´ë¦­<br>
      3. ìƒì„±ëœ í‚¤ ë³µì‚¬ í›„ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°
    </div>
    <input class="ak-input" type="password" id="ak-input" placeholder="AIzaSy..." autocomplete="off"/>
    <button class="ak-save-btn" id="ak-save-btn" onclick="saveApiKeyFirstTime()">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    <button class="ak-skip" onclick="skipApiKey()">ë‚˜ì¤‘ì— ì„¤ì •í• ê²Œìš”</button>
  </div>
</div>

<!-- CHANGE API KEY MODAL -->
<div class="modal-overlay" id="change-apikey-modal">
  <div class="modal">
    <h3>ğŸ”‘ API í‚¤ ë³€ê²½</h3>
    <p>ìƒˆ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì €ì¥ ì¦‰ì‹œ ê³„ì •ì— ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
    <input type="password" class="modal-input" id="change-api-input" placeholder="AIzaSy..." autocomplete="off"/>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeChangeApiKey()">ì·¨ì†Œ</button>
      <button class="modal-ok" onclick="confirmChangeApiKey()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- MOBILE DRAWER -->
<div id="mobile-drawer">
  <div class="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="drawer-panel">
    <div class="drawer-header">
      <h3>âš™ ì„¤ì • &amp; ê³„ì •</h3>
      <button class="drawer-close" onclick="closeDrawer()">âœ•</button>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">ê³„ì •</div>
      <div class="drawer-user-row">
        <div class="drawer-avatar" id="drawer-avatar">?</div>
        <div>
          <div class="drawer-user-name" id="drawer-name">ë¡œë”© ì¤‘...</div>
          <div class="drawer-user-email" id="drawer-email"></div>
        </div>
      </div>
      <button class="drawer-btn drawer-logout" onclick="doSignOut()">â ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">Gemini API í‚¤</div>
      <div class="drawer-api-row">
        <div class="api-dot" id="drawer-api-dot"></div>
        <span class="api-status-text" id="drawer-api-text">ë¯¸ì„¤ì •</span>
        <button class="api-edit-btn" onclick="closeDrawer();openChangeApiKey()">ë³€ê²½</button>
      </div>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">ëª¨ë¸ ì„ íƒ</div>
      <select class="drawer-model-select" id="drawer-model-select">
        <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
      </select>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">ìµœê·¼ ëŒ€í™”</div>
      <div id="drawer-chat-history"></div>
      <button class="drawer-btn" onclick="closeDrawer();newChat()">ï¼‹ ìƒˆ ì±„íŒ…</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR (Desktop & Tablet) -->
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">âœ¦</div>
      <div class="logo-text">PromptStudio</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-title">ë©”ë‰´</div>
      <button class="nav-btn active" onclick="switchView('prompt')" id="nav-prompt">
        <span class="icon">âš¡</span><span>í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°</span>
      </button>
      <button class="nav-btn" onclick="switchView('chat')" id="nav-chat">
        <span class="icon">ğŸ’¬</span><span>AI ì±„íŒ…</span>
      </button>
      <button class="nav-btn" onclick="switchView('image')" id="nav-image">
        <span class="icon">ğŸ¨</span><span>ì´ë¯¸ì§€ ìƒì„±</span>
      </button>
      <div class="nav-section-title" style="margin-top:14px;">ìµœê·¼ ëŒ€í™”</div>
      <div id="chat-history"></div>
      <button class="nav-btn" onclick="newChat()">
        <span class="icon">ï¼‹</span><span>ìƒˆ ì±„íŒ…</span>
      </button>
    </div>
    <div class="sidebar-api">
      <div class="api-status-row">
        <div class="api-dot" id="api-dot"></div>
        <span class="api-status-text" id="api-status-text">API ë¯¸ì„¤ì •</span>
        <button class="api-edit-btn" onclick="openChangeApiKey()">ë³€ê²½</button>
      </div>
    </div>
    <div class="sidebar-model">
      <select class="model-select" id="model-select">
        <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
      </select>
    </div>
    <div class="sidebar-user">
      <div class="user-row">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-meta">
          <div class="user-name" id="user-name">ë¡œë”© ì¤‘...</div>
          <div class="user-email" id="user-email"></div>
        </div>
        <button class="logout-btn" onclick="doSignOut()" title="ë¡œê·¸ì•„ì›ƒ">â</button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- TOP BAR -->
    <div class="topbar">
      <div class="topbar-title" id="topbar-title">âš¡ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°</div>
      <div class="badge" id="model-badge">Flash</div>
      <div class="topbar-actions">
        <button class="icon-btn" onclick="newChat()" title="ìƒˆ ì±„íŒ…" id="topbar-newchat-btn">âœ¦</button>
        <div class="topbar-user-btn" id="topbar-user-btn" onclick="openDrawer()">?</div>
      </div>
    </div>

    <!-- VIEWS WRAPPER -->
    <div class="views-wrap">

      <!-- PROMPT VIEW -->
      <div class="view active" id="view-prompt">
        <div class="scroll-area">
          <div class="prompt-view-inner">
            <div class="prompt-hero">
              <h1>ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼<br><span class="gradient-text">AI ìµœì  í”„ë¡¬í”„íŠ¸</span>ë¡œ</h1>
              <p>ê°„ë‹¨íˆ ì…ë ¥í•˜ë©´ AIë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì •êµí•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì¦‰ì‹œ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
            </div>
            <div class="category-scroll" id="cat-pills"></div>
            <div class="input-card">
              <textarea id="prompt-input"
                placeholder="ì˜ˆ: íŒŒì´ì¬ìœ¼ë¡œ ì›¹ ìŠ¤í¬ë˜í¼ ë§Œë“œëŠ” ë²•&#10;ì˜ˆ: ë§ˆì¼€íŒ… ì´ë©”ì¼ ë¬¸êµ¬ ì‘ì„±í•´ì¤˜&#10;ì˜ˆ: ì—¬í–‰ ê³„íš ë„ì™€ì¤˜" rows="3"></textarea>
              <div id="attach-list" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
              <div class="input-actions">
                <button class="attach-btn" onclick="document.getElementById('fup').click()">ğŸ“ íŒŒì¼</button>
                <button class="attach-btn" onclick="document.getElementById('iup').click()">ğŸ–¼ ì‚¬ì§„</button>
                <input type="file" id="fup" hidden accept=".txt,.pdf,.doc,.docx,.md" onchange="attachFile(this,'prompt')">
                <input type="file" id="iup" hidden accept="image/*" onchange="attachImage(this,'prompt')">
                <button class="gen-btn" onclick="generatePrompts()" id="gen-btn">âœ¦ ìƒì„±</button>
              </div>
            </div>
            <div id="prompt-results"></div>
          </div>
        </div>
      </div>

      <!-- CHAT VIEW -->
      <div class="view" id="view-chat">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-welcome" id="chat-welcome">
            <h2>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
            <p>Gemini AIì™€ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”.<br>íŒŒì¼ì´ë‚˜ ì´ë¯¸ì§€ë„ ì²¨ë¶€í•  ìˆ˜ ìˆì–´ìš”.</p>
            <div class="quick-prompts">
              <button class="qp-btn" onclick="quickPrompt('ì½”ë“œ ë¦¬ë·°ë¥¼ í•´ì¤˜')">ğŸ’» ì½”ë“œ ë¦¬ë·°</button>
              <button class="qp-btn" onclick="quickPrompt('ì´ë©”ì¼ ì´ˆì•ˆ ì‘ì„±í•´ì¤˜')">âœ‰ï¸ ì´ë©”ì¼</button>
              <button class="qp-btn" onclick="quickPrompt('ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° ë„ì™€ì¤˜')">ğŸ’¡ ì•„ì´ë””ì–´</button>
              <button class="qp-btn" onclick="quickPrompt('ìš”ì•½í•´ì¤˜')">ğŸ“ ìš”ì•½</button>
              <button class="qp-btn" onclick="quickPrompt('ë²ˆì—­í•´ì¤˜ (í•œì˜/ì˜í•œ)')">ğŸŒ ë²ˆì—­</button>
              <button class="qp-btn" onclick="quickPrompt('ë°ì´í„° ë¶„ì„ ë„ì™€ì¤˜')">ğŸ“Š ë¶„ì„</button>
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-box">
            <div class="chat-input-top" id="chat-attachments"></div>
            <textarea class="chat-textarea" id="chat-input"
              placeholder="ë©”ì‹œì§€ ì…ë ¥... (Enter: ì „ì†¡)" rows="1"
              onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
            <div class="chat-input-footer">
              <button class="attach-btn" onclick="document.getElementById('fuc').click()">ğŸ“</button>
              <button class="attach-btn" onclick="document.getElementById('iuc').click()">ğŸ–¼</button>
              <input type="file" id="fuc" hidden accept=".txt,.pdf,.doc,.docx,.md" onchange="attachFile(this,'chat')">
              <input type="file" id="iuc" hidden accept="image/*" onchange="attachImage(this,'chat')">
              <button class="attach-btn" id="voice-btn" onclick="toggleVoice()">ğŸ¤</button>
              <div class="recording-indicator" id="rec-indicator"><div class="rec-dot"></div><span>ë…¹ìŒ ì¤‘...</span></div>
              <button class="send-btn" id="send-btn" onclick="sendMessage()">â¤</button>
            </div>
          </div>
        </div>
      </div>

      <!-- IMAGE VIEW -->
      <div class="view" id="view-image">
        <div class="scroll-area">
          <div class="image-view-inner">
            <div class="section-header">
              <h2>ğŸ¨ ì´ë¯¸ì§€ ìƒì„±</h2>
              <span class="badge">Gemini 2.0</span>
            </div>
            <div class="imggen-card">
              <p style="color:var(--text-muted);font-size:13px;margin-bottom:14px;line-height:1.6;">ì‚¬ì´ë“œë°”ì—ì„œ Gemini 2.0 Flash ëª¨ë¸ì„ ì„ íƒí•˜ë©´ ì´ë¯¸ì§€ ìƒì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
              <div class="input-card" style="margin-bottom:14px;">
                <textarea id="image-prompt-input"
                  placeholder="ì˜ˆ: ë¯¸ë˜ë„ì‹œì˜ ìƒˆë²½, ë„¤ì˜¨ ë¶ˆë¹›, ì‚¬ì´ë²„í‘í¬ ìŠ¤íƒ€ì¼" rows="3"
                  style="width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;resize:none;line-height:1.7;"></textarea>
              </div>
              <div style="display:flex;gap:7px;margin-bottom:14px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;">
                <button class="cat-pill" style="flex-shrink:0" onclick="setImageStyle(this,'ì‚¬ì§„ì²˜ëŸ¼ ì‚¬ì‹¤ì ì¸')">ğŸ“· ì‚¬ì‹¤ì </button>
                <button class="cat-pill" style="flex-shrink:0" onclick="setImageStyle(this,'ì¼ëŸ¬ìŠ¤íŠ¸ ì•„íŠ¸')">ğŸ¨ ì¼ëŸ¬ìŠ¤íŠ¸</button>
                <button class="cat-pill" style="flex-shrink:0" onclick="setImageStyle(this,'3D ë Œë”ë§')">ğŸ§Š 3D</button>
                <button class="cat-pill" style="flex-shrink:0" onclick="setImageStyle(this,'ìˆ˜ì±„í™”')">ğŸŒŠ ìˆ˜ì±„í™”</button>
                <button class="cat-pill" style="flex-shrink:0" onclick="setImageStyle(this,'í”½ì…€ ì•„íŠ¸')">ğŸ‘¾ í”½ì…€ì•„íŠ¸</button>
              </div>
              <button class="gen-btn" style="width:100%;justify-content:center;" onclick="generateImage()">âœ¦ ì´ë¯¸ì§€ ìƒì„±</button>
            </div>
            <div class="image-grid" id="image-results">
              <div class="image-placeholder"><span class="img-icon">ğŸ–¼</span><span>ìƒì„±ëœ ì´ë¯¸ì§€</span></div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /views-wrap -->
  </div><!-- /main -->

  <!-- MOBILE BOTTOM TAB BAR -->
  <div class="bottom-tabbar">
    <button class="tab-item active" id="tab-prompt" onclick="switchView('prompt')">
      <span class="tab-icon">âš¡</span>
      <span class="tab-label">í”„ë¡¬í”„íŠ¸</span>
    </button>
    <button class="tab-item" id="tab-chat" onclick="switchView('chat')">
      <span class="tab-icon">ğŸ’¬</span>
      <span class="tab-label">ì±„íŒ…</span>
    </button>
    <button class="tab-item" id="tab-image" onclick="switchView('image')">
      <span class="tab-icon">ğŸ¨</span>
      <span class="tab-label">ì´ë¯¸ì§€</span>
    </button>
  </div>

</div><!-- /app -->

<!-- Firebase SDK -->
<script type="module">
import { initializeApp }    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as fbSignOut }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* â”€â”€ Init â”€â”€ */
const fbApp    = initializeApp(window.FIREBASE_CONFIG);
const auth     = getAuth(fbApp);
const db       = getFirestore(fbApp);
const provider = new GoogleAuthProvider();

/* â”€â”€ State â”€â”€ */
let currentUser  = null;
let apiKey       = '';
let model        = 'gemini-1.5-flash';
let chatHistory  = [];
let chatSessions = [];
let isRecording  = false;
let recognition  = null;
let promptAtt    = {files:[],images:[]};
let chatAtt      = {files:[],images:[]};
let imageStyle   = '';

/* â”€â”€ Expose globals â”€â”€ */
const G = window;
G.signInWithGoogle    = signInWithGoogle;
G.doSignOut           = doSignOut;
G.saveApiKeyFirstTime = saveApiKeyFirstTime;
G.skipApiKey          = skipApiKey;
G.openChangeApiKey    = openChangeApiKey;
G.closeChangeApiKey   = closeChangeApiKey;
G.confirmChangeApiKey = confirmChangeApiKey;
G.switchView          = switchView;
G.newChat             = newChat;
G.generatePrompts     = generatePrompts;
G.sendMessage         = sendMessage;
G.quickPrompt         = (t)=>{ document.getElementById('chat-input').value=t; sendMessage(); };
G.handleChatKey       = (e)=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} };
G.autoResize          = (el)=>{ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; };
G.toggleVoice         = toggleVoice;
G.attachFile          = attachFile;
G.attachImage         = attachImage;
G.removeChatAttach    = removeChatAttach;
G.generateImage       = generateImage;
G.setImageStyle       = (btn,s)=>{ document.querySelectorAll('.imggen-card .cat-pill').forEach(p=>p.classList.remove('active')); btn.classList.add('active'); imageStyle=s; };
G.copyText            = (btn,text)=>{ navigator.clipboard.writeText(text).then(()=>{ const o=btn.innerHTML; btn.textContent='âœ“ ë³µì‚¬ë¨'; setTimeout(()=>btn.innerHTML=o,1500); }); };
G.useInChat           = (text)=>{ switchView('chat'); document.getElementById('chat-input').value=text; G.autoResize(document.getElementById('chat-input')); showToast('ì±„íŒ…ì°½ì— í”„ë¡¬í”„íŠ¸ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤'); };
G.openDrawer          = openDrawer;
G.closeDrawer         = closeDrawer;
G.showToast           = showToast;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
onAuthStateChanged(auth, async (user) => {
  document.getElementById('loading-overlay').style.display = 'none';
  if (user) { currentUser = user; await loadUserData(user); }
  else       { currentUser = null; showLoginScreen(); }
});

async function signInWithGoogle() {
  const btn = document.getElementById('google-login-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="font-size:18px">âŸ³</span>&nbsp;ë¡œê·¸ì¸ ì¤‘...';
  document.getElementById('login-err').classList.remove('show');
  try {
    await signInWithPopup(auth, provider);
  } catch(e) {
    const el = document.getElementById('login-err');
    el.textContent = getAuthErrMsg(e.code);
    el.classList.add('show');
    btn.disabled = false;
    btn.innerHTML = googleBtnInner();
  }
}

async function doSignOut() {
  if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fbSignOut(auth);
  apiKey=''; chatHistory=[]; chatSessions=[];
  document.getElementById('app').classList.remove('show');
  closeDrawer();
  showLoginScreen();
  showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIRESTORE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadUserData(user) {
  try {
    const snap = await getDoc(doc(db,'users',user.uid));
    if (snap.exists()) {
      const d = snap.data();
      apiKey       = d.geminiApiKey || '';
      chatSessions = d.chatSessions || [];
      showApp(user);
    } else {
      showApp(user);
      document.getElementById('apikey-screen').classList.add('show');
    }
  } catch(e) {
    showApp(user);
    showToast('âš  Firestore ì˜¤ë¥˜: '+e.message);
  }
}

async function saveFS(fields) {
  if (!currentUser) return;
  try { await setDoc(doc(db,'users',currentUser.uid), fields, {merge:true}); }
  catch(e) { showToast('âš  ì €ì¥ ì˜¤ë¥˜: '+e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLoginScreen() {
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('app').classList.remove('show');
  // Reset button
  const btn = document.getElementById('google-login-btn');
  btn.disabled = false;
  btn.innerHTML = googleBtnInner();
}

function showApp(user) {
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('app').classList.add('show');

  // Set user info everywhere
  const name   = user.displayName || 'ì‚¬ìš©ì';
  const email  = user.email || '';
  const photo  = user.photoURL;
  const initial= name[0].toUpperCase();

  // Sidebar
  document.getElementById('user-name').textContent  = name;
  document.getElementById('user-email').textContent = email;
  const av = document.getElementById('user-avatar');
  av.innerHTML = photo ? `<img src="${photo}" alt="">` : initial;

  // Topbar mobile btn
  const tbBtn = document.getElementById('topbar-user-btn');
  tbBtn.innerHTML = photo ? `<img src="${photo}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : initial;

  // Drawer
  document.getElementById('drawer-name').textContent  = name;
  document.getElementById('drawer-email').textContent = email;
  const dav = document.getElementById('drawer-avatar');
  dav.innerHTML = photo ? `<img src="${photo}" alt="">` : initial;

  updateApiStatusUI();
  setupCategories();
  loadChatHistoryUI();

  // Model select sync (desktop sidebar)
  const sel = document.getElementById('model-select');
  sel.onchange = function() {
    model = this.value;
    document.getElementById('model-badge').textContent = this.options[this.selectedIndex].text.replace('Gemini ','');
    // Sync mobile drawer
    document.getElementById('drawer-model-select').value = this.value;
  };
  // Model select sync (mobile drawer)
  const dsel = document.getElementById('drawer-model-select');
  dsel.onchange = function() {
    model = this.value;
    document.getElementById('model-badge').textContent = this.options[this.selectedIndex].text.replace('Gemini ','');
    document.getElementById('model-select').value = this.value;
  };
}

/* â”€â”€ API KEY MANAGEMENT â”€â”€ */
async function saveApiKeyFirstTime() {
  const val = document.getElementById('ak-input').value.trim();
  if (!val) { showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const btn = document.getElementById('ak-save-btn');
  btn.disabled=true; btn.textContent='ì €ì¥ ì¤‘...';
  apiKey = val;
  await saveFS({geminiApiKey: val});
  btn.disabled=false; btn.textContent='ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°';
  document.getElementById('apikey-screen').classList.remove('show');
  updateApiStatusUI();
  showToast('âœ“ API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function skipApiKey() {
  document.getElementById('apikey-screen').classList.remove('show');
  showToast('ì„¤ì • ë©”ë‰´ì—ì„œ ì–¸ì œë“ ì§€ API í‚¤ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
}

function openChangeApiKey() {
  document.getElementById('change-api-input').value = '';
  document.getElementById('change-apikey-modal').classList.add('open');
}
function closeChangeApiKey() { document.getElementById('change-apikey-modal').classList.remove('open'); }
async function confirmChangeApiKey() {
  const val = document.getElementById('change-api-input').value.trim();
  if (!val) { showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  apiKey = val;
  await saveFS({geminiApiKey: val});
  closeChangeApiKey();
  updateApiStatusUI();
  showToast('âœ“ API í‚¤ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updateApiStatusUI() {
  const isOk = !!apiKey;
  // Sidebar
  const dot  = document.getElementById('api-dot');
  const text = document.getElementById('api-status-text');
  dot.classList.toggle('ok', isOk);
  text.classList.toggle('ok', isOk);
  text.textContent = isOk ? 'API ì—°ê²°ë¨' : 'API ë¯¸ì„¤ì •';
  // Drawer
  const ddot  = document.getElementById('drawer-api-dot');
  const dtext = document.getElementById('drawer-api-text');
  if (ddot)  { ddot.classList.toggle('ok', isOk); }
  if (dtext) { dtext.classList.toggle('ok', isOk); dtext.textContent = isOk ? 'ì—°ê²°ë¨' : 'ë¯¸ì„¤ì •'; }
}

/* â”€â”€ MOBILE DRAWER â”€â”€ */
function openDrawer()  { document.getElementById('mobile-drawer').classList.add('open'); }
function closeDrawer() { document.getElementById('mobile-drawer').classList.remove('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupCategories() {
  const el = document.getElementById('cat-pills');
  if (el.children.length) return;
  ['ğŸ“ ê¸€ì“°ê¸°','ğŸ’» ì½”ë”©','ğŸ¯ ë§ˆì¼€íŒ…','ğŸ“Š ë¶„ì„','ğŸ¨ ì°½ì˜','ğŸŒ ë²ˆì—­','ğŸ“š í•™ìŠµ','ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤','ğŸ”¬ ì—°êµ¬'].forEach((c,i)=>{
    const b = document.createElement('button');
    b.className = 'cat-pill' + (i===0?' active':'');
    b.textContent = c;
    b.onclick = ()=>{ document.querySelectorAll('#cat-pills .cat-pill').forEach(p=>p.classList.remove('active')); b.classList.add('active'); };
    el.appendChild(b);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchView(n) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));

  document.getElementById('view-'+n).classList.add('active');
  const navEl = document.getElementById('nav-'+n);
  if (navEl) navEl.classList.add('active');
  const tabEl = document.getElementById('tab-'+n);
  if (tabEl) tabEl.classList.add('active');

  const titles = {
    prompt: 'âš¡ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°',
    chat:   'ğŸ’¬ AI ì±„íŒ…',
    image:  'ğŸ¨ ì´ë¯¸ì§€ ìƒì„±'
  };
  document.getElementById('topbar-title').textContent = titles[n];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEMINI API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callGemini(messages, sys='') {
  if (!apiKey) { showToast('âš  API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return null; }
  const body = {
    contents: messages.map(m=>({
      role: m.role==='assistant'?'model':'user',
      parts: m.parts||[{text:m.content}]
    }))
  };
  if (sys) body.systemInstruction = {parts:[{text:sys}]};
  try {
    const res  = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
      {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}
    );
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  } catch(e) { showToast('âŒ '+e.message); return null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROMPT GENERATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PSYS = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ AI í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ AIë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ 3ê°€ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.

ê° í”„ë¡¬í”„íŠ¸ëŠ”: ëª…í™•í•œ ì—­í• /í˜ë¥´ì†Œë‚˜, êµ¬ì²´ì  ì§€ì‹œì‚¬í•­, ì¶œë ¥ í˜•ì‹ ëª…ì‹œ, ì˜ˆì‹œ/ì œì•½ì¡°ê±´ í¬í•¨.

ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”:
### í”„ë¡¬í”„íŠ¸ 1: [ìœ í˜•ëª…]
[ë‚´ìš©]

### í”„ë¡¬í”„íŠ¸ 2: [ìœ í˜•ëª…]
[ë‚´ìš©]

### í”„ë¡¬í”„íŠ¸ 3: [ìœ í˜•ëª…]
[ë‚´ìš©]`;

async function generatePrompts() {
  const inp = document.getElementById('prompt-input').value.trim();
  if (!inp) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const btn = document.getElementById('gen-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner">âŸ³</span> ìƒì„± ì¤‘...';
  document.getElementById('prompt-results').innerHTML =
    '<div style="text-align:center;padding:40px;color:var(--text-muted)"><span class="spinner" style="font-size:26px">âŸ³</span><br><br>ìµœì  í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...</div>';

  let res = await callGemini([{role:'user',content:inp}], PSYS);
  if (!res) res = demoPrompts(inp);
  btn.disabled=false; btn.innerHTML='âœ¦ ìƒì„±';
  renderResults(res);
}

function demoPrompts(inp) {
  return `### í”„ë¡¬í”„íŠ¸ 1: ì „ë¬¸ê°€ í˜ë¥´ì†Œë‚˜\në‹¹ì‹ ì€ "${inp}" ë¶„ì•¼ì˜ 10ë…„ ì´ìƒ ê²½ë ¥ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì „ë¬¸ì ì´ê³  ì‹¤ìš©ì ì¸ ê´€ì ì—ì„œ ë‹¨ê³„ë³„ë¡œ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê° ë‹¨ê³„ë§ˆë‹¤ ì£¼ì˜ì‚¬í•­ê³¼ ì˜ˆì‹œë¥¼ í¬í•¨í•˜ê³  ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n### í”„ë¡¬í”„íŠ¸ 2: êµ¬ì¡°í™” ë¶„ì„\n"${inp}"ì— ëŒ€í•´ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:\n1. í•µì‹¬ ê°œë… (3ì¤„ ìš”ì•½)\n2. ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ\n3. ì£¼ì˜ì‚¬í•­ê³¼ ìì£¼ ë°œìƒí•˜ëŠ” ì‹¤ìˆ˜\n4. ì‹¬í™” í•™ìŠµ ì¶”ì²œ\n\nê° ì„¹ì…˜ì— ì‹¤ì œ ì˜ˆì‹œë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.\n\n### í”„ë¡¬í”„íŠ¸ 3: ëŒ€í™”í˜• ì½”ì¹˜\në‚˜ëŠ” "${inp}"ë¥¼ ì²˜ìŒ ì‹œì‘í•˜ëŠ” ì´ˆë³´ìì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë‹¹ì¥ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  ì•¡ì…˜ ì•„ì´í…œì„ ì œì‹œí•˜ê³ , ìê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`;
}

function renderResults(text) {
  const sections = text.split(/###\s*í”„ë¡¬í”„íŠ¸\s*\d+[:\s]*/g).filter(s=>s.trim());
  const labels   = [...text.matchAll(/###\s*í”„ë¡¬í”„íŠ¸\s*\d+[:\s]*([^\n]+)/g)].map(m=>m[1].trim());
  const el = document.getElementById('prompt-results');
  el.innerHTML = '<div class="results-grid"></div>';
  const grid = el.querySelector('.results-grid');
  sections.forEach((sec,i)=>{
    const card = document.createElement('div');
    card.className = 'result-card';
    const safe = sec.trim().replace(/\\/g,'\\\\').replace(/`/g,'\\`');
    card.innerHTML = `
      <div class="result-label">âœ¦ ${labels[i]||'í”„ë¡¬í”„íŠ¸ '+(i+1)}</div>
      <div class="result-text">${sec.trim()}</div>
      <div class="result-actions">
        <button class="r-btn" onclick="copyText(this,\`${safe}\`)">ğŸ“‹ ë³µì‚¬</button>
        <button class="r-btn use-btn" onclick="useInChat(\`${safe}\`)">ğŸ’¬ ì±„íŒ…</button>
      </div>`;
    grid.appendChild(card);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function newChat() {
  if (chatHistory.length > 0) {
    chatSessions.unshift({
      id: Date.now(),
      title: chatHistory[0]?.content?.substring(0,26)+'â€¦' || 'ëŒ€í™”',
      history: [...chatHistory]
    });
    if (chatSessions.length > 10) chatSessions.pop();
    saveFS({chatSessions});
    loadChatHistoryUI();
  }
  chatHistory = []; chatAtt = {files:[],images:[]};
  document.getElementById('chat-messages').innerHTML = chatWelcomeHTML();
  document.getElementById('chat-attachments').innerHTML = '';
}

function chatWelcomeHTML() {
  return `<div class="chat-welcome" id="chat-welcome">
    <h2>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
    <p>Gemini AIì™€ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”.</p>
    <div class="quick-prompts">
      <button class="qp-btn" onclick="quickPrompt('ì½”ë“œ ë¦¬ë·°ë¥¼ í•´ì¤˜')">ğŸ’» ì½”ë“œ ë¦¬ë·°</button>
      <button class="qp-btn" onclick="quickPrompt('ì´ë©”ì¼ ì´ˆì•ˆ ì‘ì„±í•´ì¤˜')">âœ‰ï¸ ì´ë©”ì¼</button>
      <button class="qp-btn" onclick="quickPrompt('ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° ë„ì™€ì¤˜')">ğŸ’¡ ì•„ì´ë””ì–´</button>
      <button class="qp-btn" onclick="quickPrompt('ìš”ì•½í•´ì¤˜')">ğŸ“ ìš”ì•½</button>
      <button class="qp-btn" onclick="quickPrompt('ë²ˆì—­í•´ì¤˜ (í•œì˜/ì˜í•œ)')">ğŸŒ ë²ˆì—­</button>
      <button class="qp-btn" onclick="quickPrompt('ë°ì´í„° ë¶„ì„ ë„ì™€ì¤˜')">ğŸ“Š ë¶„ì„</button>
    </div>
  </div>`;
}

function loadChatHistoryUI() {
  // Sidebar
  const el = document.getElementById('chat-history');
  el.innerHTML = '';
  chatSessions.slice(0,5).forEach(s=>{
    const b = document.createElement('button');
    b.className = 'chat-history-item';
    b.innerHTML = `<span>ğŸ’¬</span><span class="chat-title">${s.title}</span>`;
    b.onclick = ()=>{ loadSession(s); };
    el.appendChild(b);
  });
  // Drawer
  const del = document.getElementById('drawer-chat-history');
  del.innerHTML = '';
  chatSessions.slice(0,5).forEach(s=>{
    const b = document.createElement('button');
    b.className = 'drawer-btn';
    b.innerHTML = `<span>ğŸ’¬</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${s.title}</span>`;
    b.onclick = ()=>{ closeDrawer(); loadSession(s); };
    del.appendChild(b);
  });
}

function loadSession(s) {
  chatHistory = [...s.history];
  const el = document.getElementById('chat-messages');
  el.innerHTML = '';
  chatHistory.forEach(m=>appendMsg(m.role,m.content,false));
  switchView('chat');
  el.scrollTop = el.scrollHeight;
}

async function sendMessage() {
  const inp  = document.getElementById('chat-input');
  const text = inp.value.trim();
  if (!text && !chatAtt.images.length && !chatAtt.files.length) return;

  document.getElementById('chat-welcome')?.remove();
  document.getElementById('send-btn').disabled = true;

  const parts = []; let disp = text;
  if (text) parts.push({text});
  for (const img of chatAtt.images) {
    parts.push({inlineData:{mimeType:img.mimeType,data:img.data}});
    disp += (disp?'\n':'') + `ğŸ–¼ [${img.name}]`;
  }
  for (const f of chatAtt.files) {
    parts.push({text:`\n\n[íŒŒì¼: ${f.name}]\n${f.content}`});
    disp += (disp?'\n':'') + `ğŸ“„ [${f.name}]`;
  }

  appendMsg('user', disp);
  chatHistory.push({role:'user',content:disp,parts});
  inp.value = ''; inp.style.height = 'auto';
  chatAtt = {files:[],images:[]};
  document.getElementById('chat-attachments').innerHTML = '';

  const tid  = showTyping();
  const msgs = chatHistory.map(m=>({role:m.role,parts:m.parts||[{text:m.content}]}));
  const resp = await callGemini(msgs);
  removeTyping(tid);

  if (resp) {
    appendMsg('assistant', resp);
    chatHistory.push({role:'assistant',content:resp,parts:[{text:resp}]});
  }
  document.getElementById('send-btn').disabled = false;
  const msgEl = document.getElementById('chat-messages');
  msgEl.scrollTop = msgEl.scrollHeight;
}

function appendMsg(role, content, scroll=true) {
  const el  = document.getElementById('chat-messages');
  const d   = document.createElement('div');
  d.className = `msg ${role}`;
  const av  = role==='user'
    ? (currentUser?.photoURL ? `<img src="${currentUser.photoURL}" alt="">` : (currentUser?.displayName||'ë‚˜')[0].toUpperCase())
    : 'âœ¦';
  d.innerHTML = `<div class="msg-avatar">${av}</div><div class="msg-bubble">${fmtMd(content)}</div>`;
  el.appendChild(d);
  if (scroll) el.scrollTop = el.scrollHeight;
}

function fmtMd(t) {
  return t
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`([^`]+)`/g,'<code style="background:rgba(255,255,255,.1);padding:2px 5px;border-radius:4px;font-size:.9em">$1</code>')
    .replace(/\n/g,'<br>');
}

function showTyping() {
  const el = document.getElementById('chat-messages');
  const id = 't'+Date.now();
  const d  = document.createElement('div');
  d.className = 'msg assistant'; d.id = id;
  d.innerHTML = '<div class="msg-avatar">âœ¦</div><div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>';
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
  return id;
}
function removeTyping(id) { document.getElementById(id)?.remove(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOICE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleVoice() { isRecording ? stopRec() : startRec(); }
function startRec() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'); return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'ko-KR'; recognition.continuous=false; recognition.interimResults=false;
  recognition.onresult = e=>{
    const t=e.results[0][0].transcript;
    const i=document.getElementById('chat-input');
    i.value+=(i.value?' ':'')+t; G.autoResize(i);
  };
  recognition.onend=()=>stopRec(); recognition.onerror=()=>stopRec();
  recognition.start(); isRecording=true;
  document.getElementById('rec-indicator').classList.add('active');
  document.getElementById('voice-btn').textContent='â¹';
}
function stopRec() {
  recognition?.stop(); isRecording=false;
  document.getElementById('rec-indicator').classList.remove('active');
  document.getElementById('voice-btn').textContent='ğŸ¤';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE ATTACHMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function attachFile(inp,ctx) {
  const f=inp.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    const o={name:f.name,content:e.target.result};
    if(ctx==='chat'){chatAtt.files.push(o);updateChatAttUI();}
    else{promptAtt.files.push(o);updatePromptAttUI();}
    showToast('ğŸ“„ '+f.name+' ì²¨ë¶€ë¨');
  };
  r.readAsText(f); inp.value='';
}
function attachImage(inp,ctx) {
  const f=inp.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    const o={name:f.name,data:e.target.result.split(',')[1],mimeType:f.type};
    if(ctx==='chat'){chatAtt.images.push(o);updateChatAttUI();}
    else{promptAtt.images.push(o);updatePromptAttUI();}
    showToast('ğŸ–¼ '+f.name+' ì²¨ë¶€ë¨');
  };
  r.readAsDataURL(f); inp.value='';
}
function updateChatAttUI() {
  const el=document.getElementById('chat-attachments'); el.innerHTML='';
  [...chatAtt.files,...chatAtt.images].forEach((f,i)=>{
    const d=document.createElement('div'); d.className='attach-preview';
    d.innerHTML=`${f.name} <span class="rm" onclick="removeChatAttach(${i})">âœ•</span>`;
    el.appendChild(d);
  });
}
function updatePromptAttUI() {
  const el=document.getElementById('attach-list'); el.innerHTML='';
  [...promptAtt.files,...promptAtt.images].forEach(f=>{
    const s=document.createElement('span'); s.className='file-chip'; s.textContent='ğŸ“ '+f.name; el.appendChild(s);
  });
}
function removeChatAttach(i) {
  const all=[...chatAtt.files,...chatAtt.images];
  const item=all[i];
  chatAtt.files=chatAtt.files.filter(f=>f!==item);
  chatAtt.images=chatAtt.images.filter(f=>f!==item);
  updateChatAttUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMAGE GENERATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generateImage() {
  const p=document.getElementById('image-prompt-input').value.trim();
  if(!p){showToast('ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
  if(!apiKey){showToast('âš  API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');return;}
  showToast('ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
  const full=imageStyle?`${imageStyle}: ${p}`:p;
  try {
    const res=await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
      {method:'POST',headers:{'Content-Type':'application/json'},
       body:JSON.stringify({contents:[{parts:[{text:full}]}],generationConfig:{responseModalities:['Text','Image']}})});
    const data=await res.json();
    const img=data.candidates?.[0]?.content?.parts?.find(x=>x.inlineData);
    if(img){
      document.getElementById('image-results').innerHTML=
        `<img src="data:${img.inlineData.mimeType};base64,${img.inlineData.data}" style="width:100%;border-radius:12px;border:1px solid var(--border)">`;
    } else { showToast('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨. gemini-2.0-flash ëª¨ë¸ì„ ì„ íƒí•´ë³´ì„¸ìš”.'); }
  } catch(e) { showToast('âŒ '+e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2600);
}

function googleBtnInner() {
  return `<svg viewBox="0 0 24 24" style="width:20px;height:20px;flex-shrink:0"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°`;
}

function getAuthErrMsg(code) {
  return {
    'auth/popup-closed-by-user':  'ë¡œê·¸ì¸ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
    'auth/popup-blocked':         'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.',
    'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.',
    'auth/unauthorized-domain':   'âš  ì´ ë„ë©”ì¸ì´ Firebaseì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nFirebase ì½˜ì†” â†’ Authentication â†’ Settings â†’ Authorized domainsì—ì„œ í˜„ì¬ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.',
  }[code] || ('ë¡œê·¸ì¸ ì˜¤ë¥˜: '+code);
}
</script>
</body>
</html>
