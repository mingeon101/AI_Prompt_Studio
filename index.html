<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PromptStudio AI</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

<!-- Firebase Compat SDK (no ES modules needed) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --bg:#0a0a0f; --surface:#12121a; --surface2:#1c1c28; --surface3:#222230;
  --border:rgba(255,255,255,.07); --border2:rgba(255,255,255,.12);
  --accent:#7c6dfa; --accent2:#fa6dbc; --accent3:#6dfabc;
  --text:#f0f0ff; --text-muted:#8080a0; --text-sub:#5a5a78;
  --glow:rgba(124,109,250,.25); --danger:#fa6d6d;
  --sidebar-w:260px; --topbar-h:56px; --bottombar-h:64px;
  --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overscroll-behavior:none;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 60% 50% at 10% 10%,rgba(124,109,250,.1) 0%,transparent 55%),
             radial-gradient(ellipse 50% 60% at 90% 85%,rgba(250,109,188,.07) 0%,transparent 55%);}

/* LOADING */
#loading-overlay{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.load-logo{width:60px;height:60px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:28px;animation:loadPulse 1.4s ease-in-out infinite;}
@keyframes loadPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(.92);opacity:.7}}
#loading-overlay p{color:var(--text-muted);font-size:14px;}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:800;display:none;align-items:center;justify-content:center;background:var(--bg);padding:16px;}
#login-screen.show{display:flex;}
#login-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 20% 20%,rgba(124,109,250,.15) 0%,transparent 60%),radial-gradient(ellipse 60% 70% at 80% 80%,rgba(250,109,188,.1) 0%,transparent 60%);}
.login-card{position:relative;z-index:1;background:var(--surface);border:1px solid rgba(124,109,250,.2);border-radius:28px;padding:40px 32px;width:100%;max-width:400px;text-align:center;box-shadow:0 0 80px rgba(124,109,250,.15);animation:scaleIn .4s ease;}
.login-logo{width:64px;height:64px;margin:0 auto 22px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:30px;}
.login-card h1{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;margin-bottom:8px;background:linear-gradient(135deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.login-tagline{color:var(--text-muted);font-size:13px;line-height:1.7;margin-bottom:32px;}
.google-btn{width:100%;padding:14px 18px;background:#fff;border:none;border-radius:14px;display:flex;align-items:center;justify-content:center;gap:10px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:500;color:#1f1f1f;cursor:pointer;transition:all .2s;box-shadow:0 2px 14px rgba(0,0,0,.3);}
.google-btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,0,0,.4);}
.google-btn:active{transform:translateY(0);}
.google-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
.google-btn svg{width:20px;height:20px;flex-shrink:0;}
.login-note{margin-top:20px;font-size:11px;color:var(--text-sub);line-height:1.6;}
.login-err{margin-top:14px;padding:11px 14px;background:rgba(250,109,109,.1);border:1px solid rgba(250,109,109,.3);border-radius:10px;font-size:12px;color:var(--danger);line-height:1.7;display:none;white-space:pre-line;text-align:left;}
.login-err.show{display:block;}

/* API KEY SETUP */
#apikey-screen{position:fixed;inset:0;z-index:700;display:none;align-items:center;justify-content:center;background:rgba(10,10,15,.95);backdrop-filter:blur(10px);padding:16px;}
#apikey-screen.show{display:flex;}
.apikey-card{background:var(--surface);border:1px solid rgba(124,109,250,.2);border-radius:24px;padding:36px 28px;width:100%;max-width:460px;animation:scaleIn .3s ease;max-height:90vh;overflow-y:auto;}
.apikey-card h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:6px;}
.apikey-card .sub{color:var(--text-muted);font-size:13px;line-height:1.7;margin-bottom:18px;}
.ak-steps{margin:0 0 18px;padding:14px;background:var(--surface2);border-radius:12px;font-size:12px;line-height:1.9;color:var(--text-muted);}
.ak-steps b{color:var(--text);}
.ak-steps a{color:var(--accent);text-decoration:none;}
.ak-input{width:100%;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;margin-bottom:10px;-webkit-appearance:none;}
.ak-input:focus{border-color:var(--accent);}
.ak-input::placeholder{color:var(--text-muted);}
.ak-save-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:15px;cursor:pointer;transition:all .2s;}
.ak-save-btn:hover{opacity:.88;transform:translateY(-1px);}
.ak-save-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.ak-skip{width:100%;margin-top:8px;padding:11px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all .2s;}
.ak-skip:hover{border-color:var(--accent);color:var(--text);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:600;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:28px;width:100%;max-width:420px;animation:scaleIn .25s ease;}
.modal h3{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:7px;}
.modal p{color:var(--text-muted);font-size:13px;margin-bottom:18px;line-height:1.6;}
.modal-input{width:100%;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;margin-bottom:12px;transition:border-color .2s;-webkit-appearance:none;}
.modal-input:focus{border-color:var(--accent);}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;}
.modal-cancel{padding:9px 18px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--text-muted);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;}
.modal-ok{padding:9px 18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Syne',sans-serif;font-weight:600;font-size:14px;}

/* APP */
#app{display:none;height:100vh;position:relative;z-index:1;}
#app.show{display:flex;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;height:100vh;z-index:100;}
@media(min-width:640px) and (max-width:959px){
  :root{--sidebar-w:64px;}
  .sidebar{overflow:hidden;}
  .logo-text,.nav-label,.nav-section-title,.chat-history-item,.sidebar-api,.sidebar-model,.user-meta,.logout-btn{display:none!important;}
  .nav-btn{justify-content:center;padding:12px;}
  .nav-btn .icon{width:auto;font-size:20px;}
  .logo{justify-content:center;padding:16px 0;}
  .sidebar-user{padding:10px 0;}
  .user-row{justify-content:center;padding:10px;gap:0;}
  .sidebar-nav{padding:8px 4px;}
}
@media(max-width:639px){.sidebar{display:none!important;}}
.logo{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;}
.logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:17px;}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;background:linear-gradient(135deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;}
.sidebar-nav{flex:1;padding:10px 8px;overflow-y:auto;}
.nav-section-title{font-size:10px;text-transform:uppercase;letter-spacing:.15em;color:var(--text-sub);padding:8px 10px 4px;font-weight:500;}
.nav-btn{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:none;background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all .2s;text-align:left;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:rgba(124,109,250,.15);color:var(--accent);}
.nav-btn .icon{font-size:16px;width:20px;text-align:center;flex-shrink:0;}
.chat-history-item{width:100%;display:flex;align-items:center;gap:8px;padding:7px 12px;border-radius:8px;border:none;background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;transition:all .2s;text-align:left;}
.chat-history-item:hover{background:var(--surface2);color:var(--text);}
.chat-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sidebar-api{padding:0 10px 8px;}
.api-status-row{display:flex;align-items:center;gap:7px;padding:8px 10px;border-radius:8px;background:var(--surface2);}
.api-dot{width:7px;height:7px;border-radius:50%;background:#333;flex-shrink:0;}
.api-dot.ok{background:var(--accent3);}
.api-status-text{font-size:11px;color:var(--text-muted);flex:1;}
.api-status-text.ok{color:var(--accent3);}
.api-edit-btn{font-size:11px;color:var(--accent);background:none;border:none;cursor:pointer;padding:2px 4px;white-space:nowrap;}
.sidebar-model{padding:0 10px 10px;}
.model-select{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238888aa'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
.model-select:focus{border-color:var(--accent);}
.sidebar-user{padding:10px;border-top:1px solid var(--border);flex-shrink:0;}
.user-row{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:var(--surface2);}
.user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;overflow:hidden;flex-shrink:0;}
.user-avatar img{width:100%;height:100%;object-fit:cover;}
.user-meta{flex:1;min-width:0;}
.user-name{font-size:13px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-email{font-size:11px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.logout-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:4px;border-radius:6px;transition:color .2s;flex-shrink:0;}
.logout-btn:hover{color:var(--danger);}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* TOPBAR */
.topbar{height:var(--topbar-h);padding:0 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:rgba(10,10,15,.88);backdrop-filter:blur(12px);flex-shrink:0;position:relative;z-index:10;}
.topbar-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.badge{padding:3px 8px;border-radius:20px;font-size:11px;font-weight:500;background:rgba(124,109,250,.15);color:var(--accent);border:1px solid rgba(124,109,250,.3);white-space:nowrap;}
.topbar-actions{margin-left:auto;display:flex;gap:6px;align-items:center;}
.icon-btn{width:34px;height:34px;background:var(--surface);border:1px solid var(--border);border-radius:9px;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;}
.icon-btn:hover{color:var(--text);border-color:var(--accent);}
.topbar-user-btn{width:32px;height:32px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,var(--accent),var(--accent2));display:none;align-items:center;justify-content:center;font-size:13px;font-weight:700;cursor:pointer;border:2px solid rgba(124,109,250,.4);flex-shrink:0;}
.topbar-user-btn img{width:100%;height:100%;object-fit:cover;}
@media(max-width:639px){.topbar-user-btn{display:flex;}}

/* MOBILE DRAWER */
#mobile-drawer{position:fixed;inset:0;z-index:500;display:none;}
#mobile-drawer.open{display:block;}
.drawer-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);}
.drawer-panel{position:absolute;right:0;top:0;bottom:0;width:280px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;animation:slideInRight .28s ease;overflow-y:auto;}
@keyframes slideInRight{from{transform:translateX(100%)}to{transform:translateX(0)}}
.drawer-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.drawer-header h3{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;}
.drawer-close{background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;padding:4px;}
.drawer-section{padding:16px;border-bottom:1px solid var(--border);}
.drawer-section-title{font-size:11px;text-transform:uppercase;letter-spacing:.1em;color:var(--text-sub);margin-bottom:10px;font-weight:500;}
.drawer-user-row{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.drawer-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;overflow:hidden;flex-shrink:0;}
.drawer-avatar img{width:100%;height:100%;object-fit:cover;}
.drawer-user-name{font-size:14px;font-weight:500;}
.drawer-user-email{font-size:12px;color:var(--text-muted);}
.drawer-api-row{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:10px;margin-bottom:8px;}
.drawer-model-select{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;cursor:pointer;-webkit-appearance:none;appearance:none;}
.drawer-btn{width:100%;padding:11px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;transition:all .2s;text-align:left;display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.drawer-btn:hover{background:var(--surface2);color:var(--text);}
.drawer-logout{color:var(--danger);border-color:rgba(250,109,109,.3);}

/* VIEWS */
.views-wrap{flex:1;overflow:hidden;position:relative;}
.view{display:none;height:100%;flex-direction:column;}
.view.active{display:flex;}
.scroll-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}

/* PROMPT VIEW */
.prompt-view-inner{padding:28px 32px;}
@media(max-width:639px){.prompt-view-inner{padding:20px 16px;}}
@media(min-width:640px) and (max-width:959px){.prompt-view-inner{padding:24px 20px;}}
.prompt-hero{text-align:center;margin-bottom:28px;animation:fadeUp .5s ease both;}
.prompt-hero h1{font-family:'Syne',sans-serif;font-weight:800;font-size:clamp(22px,4vw,38px);line-height:1.2;margin-bottom:10px;}
.gradient-text{background:linear-gradient(90deg,var(--accent) 0%,var(--accent2) 50%,var(--accent3) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.prompt-hero p{color:var(--text-muted);font-size:14px;max-width:480px;margin:0 auto;line-height:1.6;}
.category-scroll{display:flex;gap:8px;margin-bottom:18px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}
.category-scroll::-webkit-scrollbar{display:none;}
@media(min-width:640px){.category-scroll{flex-wrap:wrap;justify-content:center;}}
.cat-pill{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:13px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;white-space:nowrap;flex-shrink:0;}
.cat-pill:hover{border-color:var(--accent);color:var(--accent);}
.cat-pill.active{background:rgba(124,109,250,.2);border-color:var(--accent);color:var(--text);}
.input-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:20px;animation:fadeUp .5s .08s ease both;transition:border-color .2s;}
.input-card:focus-within{border-color:rgba(124,109,250,.4);}
.input-card textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;resize:none;min-height:80px;line-height:1.7;-webkit-appearance:none;}
.input-card textarea::placeholder{color:var(--text-muted);}
.input-actions{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);flex-wrap:wrap;}
.attach-btn{padding:7px 12px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.attach-btn:hover{border-color:var(--accent);color:var(--text);}
.gen-btn{margin-left:auto;padding:9px 18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-family:'Syne',sans-serif;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.gen-btn:hover{opacity:.85;transform:translateY(-1px);box-shadow:0 4px 18px var(--glow);}
.gen-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.results-grid{display:grid;grid-template-columns:1fr;gap:14px;}
.result-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;transition:border-color .2s;animation:fadeUp .4s ease both;}
.result-card:hover{border-color:rgba(124,109,250,.35);}
.result-label{font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:var(--accent);font-weight:600;margin-bottom:10px;}
.result-text{font-size:13px;line-height:1.8;color:var(--text);white-space:pre-wrap;}
.result-actions{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);flex-wrap:wrap;}
.r-btn{padding:6px 12px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:4px;}
.r-btn:hover{background:var(--surface2);color:var(--text);}
.r-btn.use-btn{background:rgba(124,109,250,.15);color:var(--accent);border-color:rgba(124,109,250,.3);}
.r-btn.use-btn:hover{background:rgba(124,109,250,.25);}

/* CHAT */
.chat-messages{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px 32px;display:flex;flex-direction:column;gap:14px;}
@media(max-width:639px){.chat-messages{padding:16px 14px;}}
@media(min-width:640px) and (max-width:959px){.chat-messages{padding:16px 20px;}}
.chat-welcome{text-align:center;padding:48px 20px;color:var(--text-muted);}
.chat-welcome h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:8px;color:var(--text);}
.chat-welcome p{font-size:13px;line-height:1.6;}
.quick-prompts{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:20px;}
.qp-btn{padding:8px 14px;background:var(--surface);border:1px solid var(--border);border-radius:20px;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;}
.qp-btn:hover{border-color:var(--accent);color:var(--text);background:rgba(124,109,250,.1);}
.qp-btn:active{transform:scale(.97);}
.msg{display:flex;gap:10px;animation:fadeUp .25s ease;}
.msg.user{flex-direction:row-reverse;align-self:flex-end;max-width:85%;}
.msg.assistant{align-self:flex-start;max-width:85%;}
@media(min-width:640px){.msg.user,.msg.assistant{max-width:70%;}}
.msg-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;overflow:hidden;}
.msg.user .msg-avatar{background:linear-gradient(135deg,var(--accent),var(--accent2));}
.msg.assistant .msg-avatar{background:var(--surface2);border:1px solid var(--border);font-size:14px;}
.msg.user .msg-avatar img{width:100%;height:100%;object-fit:cover;}
.msg-bubble{padding:11px 15px;border-radius:14px;font-size:14px;line-height:1.7;}
@media(max-width:639px){.msg-bubble{font-size:13px;padding:10px 13px;}}
.msg.user .msg-bubble{background:linear-gradient(135deg,rgba(124,109,250,.22),rgba(250,109,188,.13));border:1px solid rgba(124,109,250,.28);border-top-right-radius:4px;}
.msg.assistant .msg-bubble{background:var(--surface);border:1px solid var(--border);border-top-left-radius:4px;}
.typing-dots span{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;margin:0 2px;animation:dot 1.4s infinite;}
.typing-dots span:nth-child(2){animation-delay:.2s;}
.typing-dots span:nth-child(3){animation-delay:.4s;}

/* CHAT INPUT */
.chat-input-area{padding:12px 24px calc(12px + var(--safe-bottom)) 24px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0;}
@media(max-width:639px){.chat-input-area{padding:10px 12px calc(var(--bottombar-h) + 10px + var(--safe-bottom)) 12px;}}
@media(min-width:640px) and (max-width:959px){.chat-input-area{padding:12px 16px;}}
.chat-input-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:12px 14px;transition:border-color .2s;}
.chat-input-box:focus-within{border-color:rgba(124,109,250,.5);}
.chat-input-top{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
.attach-preview{display:flex;align-items:center;gap:5px;padding:3px 9px;background:rgba(124,109,250,.15);border:1px solid rgba(124,109,250,.3);border-radius:7px;font-size:11px;color:var(--accent);}
.attach-preview .rm{cursor:pointer;opacity:.6;}
.attach-preview .rm:hover{opacity:1;}
.chat-textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;resize:none;max-height:120px;line-height:1.6;-webkit-appearance:none;}
@media(max-width:639px){.chat-textarea{font-size:16px;}}
.chat-textarea::placeholder{color:var(--text-muted);}
.chat-input-footer{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);}
.send-btn{margin-left:auto;width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;flex-shrink:0;}
.send-btn:hover{opacity:.85;transform:scale(1.05);}
.send-btn:active{transform:scale(.95);}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.recording-indicator{display:none;align-items:center;gap:6px;color:#ff4444;font-size:12px;}
.recording-indicator.active{display:flex;animation:pulse 1s infinite;}
.rec-dot{width:7px;height:7px;background:#ff4444;border-radius:50%;}

/* IMAGE VIEW */
.image-view-inner{padding:28px 32px;}
@media(max-width:639px){.image-view-inner{padding:20px 16px;}}
@media(min-width:640px) and (max-width:959px){.image-view-inner{padding:24px 20px;}}
.section-header{display:flex;align-items:center;gap:12px;margin-bottom:22px;}
.section-header h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;}
.imggen-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;max-width:560px;margin:0 auto;}
.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-top:22px;}
.image-placeholder{aspect-ratio:1;background:var(--surface);border:1px dashed var(--border);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-muted);font-size:13px;gap:8px;}
.img-icon{font-size:30px;}
.file-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:rgba(109,250,188,.1);border:1px solid rgba(109,250,188,.3);border-radius:20px;font-size:11px;color:var(--accent3);margin-top:6px;}

/* BOTTOM TAB BAR */
.bottom-tabbar{display:none;position:fixed;bottom:0;left:0;right:0;height:calc(var(--bottombar-h) + var(--safe-bottom));padding-bottom:var(--safe-bottom);background:var(--surface);border-top:1px solid var(--border);z-index:50;align-items:center;justify-content:space-around;}
@media(max-width:639px){.bottom-tabbar{display:flex;}}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:8px 4px;cursor:pointer;border:none;background:transparent;color:var(--text-sub);transition:color .2s;}
.tab-item.active{color:var(--accent);}
.tab-icon{font-size:20px;line-height:1;}
.tab-label{font-size:10px;font-family:'DM Sans',sans-serif;font-weight:500;letter-spacing:.02em;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--bottombar-h) + 14px + var(--safe-bottom));left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);border:1px solid var(--border2);border-radius:12px;padding:10px 18px;font-size:13px;z-index:700;transition:all .3s ease;pointer-events:none;white-space:nowrap;opacity:0;}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
@media(min-width:640px){.toast{bottom:20px;}}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
@keyframes dot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.spinner{display:inline-block;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
  <div class="load-logo">âœ¦</div>
  <p>ë¡œë”© ì¤‘...</p>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">âœ¦</div>
    <h1>PromptStudio AI</h1>
    <p class="login-tagline">ê°„ë‹¨í•œ ì…ë ¥ìœ¼ë¡œ AIë¥¼ ìµœëŒ€ë¡œ í™œìš©í•˜ëŠ”<br>ìµœì í™” í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.<br>ë¡œê·¸ì¸í•˜ë©´ API í‚¤ê°€ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</p>
    <button class="google-btn" id="google-login-btn">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
    </button>
    <div class="login-err" id="login-err"></div>
    <p class="login-note">ë¡œê·¸ì¸í•˜ë©´ API í‚¤ê°€ ê³„ì •ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì–´<br>ë‹¤ìŒ ë°©ë¬¸ ì‹œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
  </div>
</div>

<!-- API KEY SETUP -->
<div id="apikey-screen">
  <div class="apikey-card">
    <h2>ğŸ”‘ Gemini API í‚¤ ì„¤ì •</h2>
    <p class="sub">ì²˜ìŒ ë¡œê·¸ì¸í•˜ì…¨ì–´ìš”! API í‚¤ë¥¼ ë“±ë¡í•˜ë©´ ì´í›„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
    <div class="ak-steps">
      <b>ë¬´ë£Œ API í‚¤ ë°œê¸‰ ë°©ë²•</b><br>
      1. <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> ì ‘ì†<br>
      2. <b>Get API key â†’ Create API key</b> í´ë¦­<br>
      3. ìƒì„±ëœ í‚¤ ë³µì‚¬ í›„ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°
    </div>
    <input class="ak-input" type="password" id="ak-input" placeholder="AIzaSy..." autocomplete="off"/>
    <button class="ak-save-btn" id="ak-save-btn">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    <button class="ak-skip" id="ak-skip">ë‚˜ì¤‘ì— ì„¤ì •í• ê²Œìš”</button>
  </div>
</div>

<!-- CHANGE API KEY MODAL -->
<div class="modal-overlay" id="change-apikey-modal">
  <div class="modal">
    <h3>ğŸ”‘ API í‚¤ ë³€ê²½</h3>
    <p>ìƒˆ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì €ì¥ ì¦‰ì‹œ ê³„ì •ì— ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
    <input type="password" class="modal-input" id="change-api-input" placeholder="AIzaSy..." autocomplete="off"/>
    <div class="modal-actions">
      <button class="modal-cancel" id="modal-cancel-btn">ì·¨ì†Œ</button>
      <button class="modal-ok" id="modal-ok-btn">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- MOBILE DRAWER -->
<div id="mobile-drawer">
  <div class="drawer-backdrop" id="drawer-backdrop"></div>
  <div class="drawer-panel">
    <div class="drawer-header">
      <h3>ì„¤ì • &amp; ê³„ì •</h3>
      <button class="drawer-close" id="drawer-close-btn">âœ•</button>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">ê³„ì •</div>
      <div class="drawer-user-row">
        <div class="drawer-avatar" id="drawer-avatar">?</div>
        <div>
          <div class="drawer-user-name" id="drawer-name">ë¡œë”© ì¤‘...</div>
          <div class="drawer-user-email" id="drawer-email"></div>
        </div>
      </div>
      <button class="drawer-btn drawer-logout" id="drawer-logout-btn">â ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">Gemini API í‚¤</div>
      <div class="drawer-api-row">
        <div class="api-dot" id="drawer-api-dot"></div>
        <span class="api-status-text" id="drawer-api-text">ë¯¸ì„¤ì •</span>
        <button class="api-edit-btn" id="drawer-apikey-btn">ë³€ê²½</button>
      </div>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">ëª¨ë¸ ì„ íƒ</div>
      <select class="drawer-model-select" id="drawer-model-select">
        <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
      </select>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">ìµœê·¼ ëŒ€í™”</div>
      <div id="drawer-chat-history"></div>
      <button class="drawer-btn" id="drawer-newchat-btn">ï¼‹ ìƒˆ ì±„íŒ…</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- APP -->
<div id="app">
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">âœ¦</div>
      <div class="logo-text">PromptStudio</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-title">ë©”ë‰´</div>
      <button class="nav-btn active" id="nav-prompt">
        <span class="icon">âš¡</span><span class="nav-label">í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°</span>
      </button>
      <button class="nav-btn" id="nav-chat">
        <span class="icon">ğŸ’¬</span><span class="nav-label">AI ì±„íŒ…</span>
      </button>
      <button class="nav-btn" id="nav-image">
        <span class="icon">ğŸ¨</span><span class="nav-label">ì´ë¯¸ì§€ ìƒì„±</span>
      </button>
      <div class="nav-section-title" style="margin-top:14px;">ìµœê·¼ ëŒ€í™”</div>
      <div id="chat-history"></div>
      <button class="nav-btn" id="sidebar-newchat-btn">
        <span class="icon">ï¼‹</span><span class="nav-label">ìƒˆ ì±„íŒ…</span>
      </button>
    </div>
    <div class="sidebar-api">
      <div class="api-status-row">
        <div class="api-dot" id="api-dot"></div>
        <span class="api-status-text" id="api-status-text">API ë¯¸ì„¤ì •</span>
        <button class="api-edit-btn" id="sidebar-apikey-btn">ë³€ê²½</button>
      </div>
    </div>
    <div class="sidebar-model">
      <select class="model-select" id="model-select">
        <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
      </select>
    </div>
    <div class="sidebar-user">
      <div class="user-row">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-meta">
          <div class="user-name" id="user-name">ë¡œë”© ì¤‘...</div>
          <div class="user-email" id="user-email"></div>
        </div>
        <button class="logout-btn" id="sidebar-logout-btn" title="ë¡œê·¸ì•„ì›ƒ">â</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbar-title">âš¡ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°</div>
      <div class="badge" id="model-badge">Flash</div>
      <div class="topbar-actions">
        <button class="icon-btn" id="topbar-newchat-btn" title="ìƒˆ ì±„íŒ…">âœ¦</button>
        <div class="topbar-user-btn" id="topbar-user-btn">?</div>
      </div>
    </div>

    <div class="views-wrap">

      <!-- PROMPT VIEW -->
      <div class="view active" id="view-prompt">
        <div class="scroll-area">
          <div class="prompt-view-inner">
            <div class="prompt-hero">
              <h1>ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼<br><span class="gradient-text">AI ìµœì  í”„ë¡¬í”„íŠ¸</span>ë¡œ</h1>
              <p>ê°„ë‹¨íˆ ì…ë ¥í•˜ë©´ AIë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì •êµí•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì¦‰ì‹œ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
            </div>
            <div class="category-scroll" id="cat-pills"></div>
            <div class="input-card">
              <textarea id="prompt-input" placeholder="ì˜ˆ: íŒŒì´ì¬ìœ¼ë¡œ ì›¹ ìŠ¤í¬ë˜í¼ ë§Œë“œëŠ” ë²•&#10;ì˜ˆ: ë§ˆì¼€íŒ… ì´ë©”ì¼ ë¬¸êµ¬ ì‘ì„±í•´ì¤˜&#10;ì˜ˆ: ì—¬í–‰ ê³„íš ë„ì™€ì¤˜" rows="3"></textarea>
              <div id="attach-list" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
              <div class="input-actions">
                <button class="attach-btn" id="prompt-file-btn">ğŸ“ íŒŒì¼</button>
                <button class="attach-btn" id="prompt-img-btn">ğŸ–¼ ì‚¬ì§„</button>
                <input type="file" id="fup" style="display:none" accept=".txt,.pdf,.doc,.docx,.md">
                <input type="file" id="iup" style="display:none" accept="image/*">
                <button class="gen-btn" id="gen-btn">âœ¦ ìƒì„±</button>
              </div>
            </div>
            <div id="prompt-results"></div>
          </div>
        </div>
      </div>

      <!-- CHAT VIEW -->
      <div class="view" id="view-chat">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-welcome" id="chat-welcome">
            <h2>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
            <p>Gemini AIì™€ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”.<br>íŒŒì¼ì´ë‚˜ ì´ë¯¸ì§€ë„ ì²¨ë¶€í•  ìˆ˜ ìˆì–´ìš”.</p>
            <div class="quick-prompts" id="quick-prompts"></div>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-box">
            <div class="chat-input-top" id="chat-attachments"></div>
            <textarea class="chat-textarea" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥... (Enter: ì „ì†¡)" rows="1"></textarea>
            <div class="chat-input-footer">
              <button class="attach-btn" id="chat-file-btn">ğŸ“</button>
              <button class="attach-btn" id="chat-img-btn">ğŸ–¼</button>
              <input type="file" id="fuc" style="display:none" accept=".txt,.pdf,.doc,.docx,.md">
              <input type="file" id="iuc" style="display:none" accept="image/*">
              <button class="attach-btn" id="voice-btn">ğŸ¤</button>
              <div class="recording-indicator" id="rec-indicator"><div class="rec-dot"></div><span>ë…¹ìŒ ì¤‘...</span></div>
              <button class="send-btn" id="send-btn">â¤</button>
            </div>
          </div>
        </div>
      </div>

      <!-- IMAGE VIEW -->
      <div class="view" id="view-image">
        <div class="scroll-area">
          <div class="image-view-inner">
            <div class="section-header">
              <h2>ğŸ¨ ì´ë¯¸ì§€ ìƒì„±</h2>
              <span class="badge">Gemini 2.0</span>
            </div>
            <div class="imggen-card">
              <p style="color:var(--text-muted);font-size:13px;margin-bottom:14px;line-height:1.6;">Gemini 2.0 Flash ëª¨ë¸ì„ ì„ íƒí•˜ë©´ ì´ë¯¸ì§€ ìƒì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
              <div class="input-card" style="margin-bottom:14px;">
                <textarea id="image-prompt-input" placeholder="ì˜ˆ: ë¯¸ë˜ë„ì‹œì˜ ìƒˆë²½, ë„¤ì˜¨ ë¶ˆë¹›, ì‚¬ì´ë²„í‘í¬ ìŠ¤íƒ€ì¼" rows="3"
                  style="width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;resize:none;line-height:1.7;"></textarea>
              </div>
              <div style="display:flex;gap:7px;margin-bottom:14px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;" id="img-style-pills">
                <button class="cat-pill" style="flex-shrink:0" data-style="ì‚¬ì§„ì²˜ëŸ¼ ì‚¬ì‹¤ì ì¸">ğŸ“· ì‚¬ì‹¤ì </button>
                <button class="cat-pill" style="flex-shrink:0" data-style="ì¼ëŸ¬ìŠ¤íŠ¸ ì•„íŠ¸">ğŸ¨ ì¼ëŸ¬ìŠ¤íŠ¸</button>
                <button class="cat-pill" style="flex-shrink:0" data-style="3D ë Œë”ë§">ğŸ§Š 3D</button>
                <button class="cat-pill" style="flex-shrink:0" data-style="ìˆ˜ì±„í™”">ğŸŒŠ ìˆ˜ì±„í™”</button>
                <button class="cat-pill" style="flex-shrink:0" data-style="í”½ì…€ ì•„íŠ¸">ğŸ‘¾ í”½ì…€ì•„íŠ¸</button>
              </div>
              <button class="gen-btn" style="width:100%;justify-content:center;" id="img-gen-btn">âœ¦ ì´ë¯¸ì§€ ìƒì„±</button>
            </div>
            <div class="image-grid" id="image-results">
              <div class="image-placeholder"><span class="img-icon">ğŸ–¼</span><span>ìƒì„±ëœ ì´ë¯¸ì§€</span></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- BOTTOM TAB BAR (mobile) -->
  <div class="bottom-tabbar">
    <button class="tab-item active" id="tab-prompt">
      <span class="tab-icon">âš¡</span>
      <span class="tab-label">í”„ë¡¬í”„íŠ¸</span>
    </button>
    <button class="tab-item" id="tab-chat">
      <span class="tab-icon">ğŸ’¬</span>
      <span class="tab-label">ì±„íŒ…</span>
    </button>
    <button class="tab-item" id="tab-image">
      <span class="tab-icon">ğŸ¨</span>
      <span class="tab-label">ì´ë¯¸ì§€</span>
    </button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase ì´ˆê¸°í™” (compat SDK)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp(window.FIREBASE_CONFIG);
var auth = firebase.auth();
var db   = firebase.firestore();
var googleProvider = new firebase.auth.GoogleAuthProvider();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì•± ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentUser  = null;
var apiKey       = '';
var model        = 'gemini-1.5-flash';
var chatHistory  = [];
var chatSessions = [];
var isRecording  = false;
var recognition  = null;
var promptAtt    = {files:[], images:[]};
var chatAtt      = {files:[], images:[]};
var imageStyle   = '';

var QUICK_PROMPTS = [
  {icon:'ğŸ’»', text:'ì½”ë“œ ë¦¬ë·°ë¥¼ í•´ì¤˜'},
  {icon:'âœ‰ï¸', text:'ì´ë©”ì¼ ì´ˆì•ˆ ì‘ì„±í•´ì¤˜'},
  {icon:'ğŸ’¡', text:'ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° ë„ì™€ì¤˜'},
  {icon:'ğŸ“', text:'ìš”ì•½í•´ì¤˜'},
  {icon:'ğŸŒ', text:'ë²ˆì—­í•´ì¤˜ (í•œì˜/ì˜í•œ)'},
  {icon:'ğŸ“Š', text:'ë°ì´í„° ë¶„ì„ ë„ì™€ì¤˜'}
];

var CATEGORIES = ['ğŸ“ ê¸€ì“°ê¸°','ğŸ’» ì½”ë”©','ğŸ¯ ë§ˆì¼€íŒ…','ğŸ“Š ë¶„ì„','ğŸ¨ ì°½ì˜','ğŸŒ ë²ˆì—­','ğŸ“š í•™ìŠµ','ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤','ğŸ”¬ ì—°êµ¬'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM ì¤€ë¹„ í›„ ì´ë²¤íŠ¸ ì—°ê²°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', function() {
  // Login
  document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);

  // API key screens
  document.getElementById('ak-save-btn').addEventListener('click', saveApiKeyFirstTime);
  document.getElementById('ak-skip').addEventListener('click', skipApiKey);
  document.getElementById('modal-cancel-btn').addEventListener('click', closeChangeApiKey);
  document.getElementById('modal-ok-btn').addEventListener('click', confirmChangeApiKey);
  document.getElementById('sidebar-apikey-btn').addEventListener('click', openChangeApiKey);
  document.getElementById('drawer-apikey-btn').addEventListener('click', function(){ closeDrawer(); openChangeApiKey(); });

  // Nav buttons
  document.getElementById('nav-prompt').addEventListener('click', function(){ switchView('prompt'); });
  document.getElementById('nav-chat').addEventListener('click', function(){ switchView('chat'); });
  document.getElementById('nav-image').addEventListener('click', function(){ switchView('image'); });

  // Tab bar
  document.getElementById('tab-prompt').addEventListener('click', function(){ switchView('prompt'); });
  document.getElementById('tab-chat').addEventListener('click', function(){ switchView('chat'); });
  document.getElementById('tab-image').addEventListener('click', function(){ switchView('image'); });

  // New chat
  document.getElementById('sidebar-newchat-btn').addEventListener('click', newChat);
  document.getElementById('topbar-newchat-btn').addEventListener('click', newChat);
  document.getElementById('drawer-newchat-btn').addEventListener('click', function(){ closeDrawer(); newChat(); });

  // Logout
  document.getElementById('sidebar-logout-btn').addEventListener('click', doSignOut);
  document.getElementById('drawer-logout-btn').addEventListener('click', doSignOut);

  // User drawer (mobile)
  document.getElementById('topbar-user-btn').addEventListener('click', openDrawer);
  document.getElementById('drawer-backdrop').addEventListener('click', closeDrawer);
  document.getElementById('drawer-close-btn').addEventListener('click', closeDrawer);

  // Model select (sidebar)
  document.getElementById('model-select').addEventListener('change', function() {
    model = this.value;
    updateModelBadge(this.options[this.selectedIndex].text);
    document.getElementById('drawer-model-select').value = this.value;
  });
  // Model select (drawer)
  document.getElementById('drawer-model-select').addEventListener('change', function() {
    model = this.value;
    updateModelBadge(this.options[this.selectedIndex].text);
    document.getElementById('model-select').value = this.value;
  });

  // Prompt generator
  document.getElementById('gen-btn').addEventListener('click', generatePrompts);
  document.getElementById('prompt-file-btn').addEventListener('click', function(){ document.getElementById('fup').click(); });
  document.getElementById('prompt-img-btn').addEventListener('click', function(){ document.getElementById('iup').click(); });
  document.getElementById('fup').addEventListener('change', function(){ attachFile(this, 'prompt'); });
  document.getElementById('iup').addEventListener('change', function(){ attachImage(this, 'prompt'); });

  // Chat
  document.getElementById('send-btn').addEventListener('click', sendMessage);
  document.getElementById('chat-input').addEventListener('keydown', function(e){
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  document.getElementById('chat-input').addEventListener('input', function(){ autoResize(this); });
  document.getElementById('chat-file-btn').addEventListener('click', function(){ document.getElementById('fuc').click(); });
  document.getElementById('chat-img-btn').addEventListener('click', function(){ document.getElementById('iuc').click(); });
  document.getElementById('fuc').addEventListener('change', function(){ attachFile(this, 'chat'); });
  document.getElementById('iuc').addEventListener('change', function(){ attachImage(this, 'chat'); });
  document.getElementById('voice-btn').addEventListener('click', toggleVoice);

  // Image generation
  document.getElementById('img-gen-btn').addEventListener('click', generateImage);
  document.querySelectorAll('#img-style-pills .cat-pill').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#img-style-pills .cat-pill').forEach(function(p){ p.classList.remove('active'); });
      btn.classList.add('active');
      imageStyle = btn.getAttribute('data-style');
    });
  });

  // Quick prompts
  var qp = document.getElementById('quick-prompts');
  QUICK_PROMPTS.forEach(function(item) {
    var btn = document.createElement('button');
    btn.className = 'qp-btn';
    btn.textContent = item.icon + ' ' + item.text.replace('ë¥¼ í•´ì¤˜','').replace('ì„ í•´ì¤˜','').replace(' ë„ì™€ì¤˜','').replace(' ì‘ì„±í•´ì¤˜','');
    btn.addEventListener('click', function(){ quickPrompt(item.text); });
    qp.appendChild(btn);
  });

  // Categories
  CATEGORIES.forEach(function(c, i) {
    var btn = document.createElement('button');
    btn.className = 'cat-pill' + (i === 0 ? ' active' : '');
    btn.textContent = c;
    btn.addEventListener('click', function() {
      document.querySelectorAll('#cat-pills .cat-pill').forEach(function(p){ p.classList.remove('active'); });
      btn.classList.add('active');
    });
    document.getElementById('cat-pills').appendChild(btn);
  });

  // Modal close on backdrop
  document.getElementById('change-apikey-modal').addEventListener('click', function(e){
    if (e.target === this) closeChangeApiKey();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
auth.onAuthStateChanged(function(user) {
  document.getElementById('loading-overlay').style.display = 'none';
  if (user) {
    currentUser = user;
    loadUserData(user);
  } else {
    currentUser = null;
    showLoginScreen();
  }
});

function signInWithGoogle() {
  var btn = document.getElementById('google-login-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="font-size:18px">âŸ³</span>&nbsp;ë¡œê·¸ì¸ ì¤‘...';
  document.getElementById('login-err').classList.remove('show');
  auth.signInWithPopup(googleProvider).catch(function(e) {
    var el = document.getElementById('login-err');
    el.textContent = getAuthErrMsg(e.code);
    el.classList.add('show');
    btn.disabled = false;
    btn.innerHTML = googleBtnHTML();
  });
}

function doSignOut() {
  if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  auth.signOut().then(function() {
    apiKey = ''; chatHistory = []; chatSessions = [];
    document.getElementById('app').classList.remove('show');
    closeDrawer();
    showLoginScreen();
    showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIRESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadUserData(user) {
  db.collection('users').doc(user.uid).get().then(function(snap) {
    if (snap.exists) {
      var d = snap.data();
      apiKey       = d.geminiApiKey || '';
      chatSessions = d.chatSessions || [];
    }
    showApp(user);
    if (!snap.exists) {
      document.getElementById('apikey-screen').classList.add('show');
    }
  }).catch(function(e) {
    showApp(user);
    showToast('âš  Firestore ì˜¤ë¥˜: ' + e.message);
  });
}

function saveFS(fields) {
  if (!currentUser) return;
  db.collection('users').doc(currentUser.uid).set(fields, {merge:true}).catch(function(e) {
    showToast('âš  ì €ì¥ ì˜¤ë¥˜: ' + e.message);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoginScreen() {
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('app').classList.remove('show');
  var btn = document.getElementById('google-login-btn');
  btn.disabled = false;
  btn.innerHTML = googleBtnHTML();
}

function showApp(user) {
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('app').classList.add('show');

  var name    = user.displayName || 'ì‚¬ìš©ì';
  var email   = user.email || '';
  var photo   = user.photoURL;
  var initial = name[0].toUpperCase();
  var avatarHTML = photo ? '<img src="' + photo + '" alt="">' : initial;

  document.getElementById('user-name').textContent  = name;
  document.getElementById('user-email').textContent = email;
  document.getElementById('user-avatar').innerHTML  = avatarHTML;
  document.getElementById('drawer-name').textContent  = name;
  document.getElementById('drawer-email').textContent = email;
  document.getElementById('drawer-avatar').innerHTML  = avatarHTML;
  document.getElementById('topbar-user-btn').innerHTML =
    photo ? '<img src="' + photo + '" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%">' : initial;

  updateApiStatusUI();
  loadChatHistoryUI();
}

function updateModelBadge(text) {
  document.getElementById('model-badge').textContent = text.replace('Gemini ', '');
}

// â”€â”€ API KEY â”€â”€
function saveApiKeyFirstTime() {
  var val = document.getElementById('ak-input').value.trim();
  if (!val) { showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('ak-save-btn');
  btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...';
  apiKey = val;
  saveFS({geminiApiKey: val});
  setTimeout(function() {
    btn.disabled = false; btn.textContent = 'ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°';
    document.getElementById('apikey-screen').classList.remove('show');
    updateApiStatusUI();
    showToast('âœ“ API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
  }, 800);
}

function skipApiKey() {
  document.getElementById('apikey-screen').classList.remove('show');
  showToast('ì„¤ì •ì—ì„œ ì–¸ì œë“ ì§€ API í‚¤ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
}

function openChangeApiKey() {
  document.getElementById('change-api-input').value = '';
  document.getElementById('change-apikey-modal').classList.add('open');
}
function closeChangeApiKey() {
  document.getElementById('change-apikey-modal').classList.remove('open');
}
function confirmChangeApiKey() {
  var val = document.getElementById('change-api-input').value.trim();
  if (!val) { showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  apiKey = val;
  saveFS({geminiApiKey: val});
  closeChangeApiKey();
  updateApiStatusUI();
  showToast('âœ“ API í‚¤ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updateApiStatusUI() {
  var isOk = !!apiKey;
  // Sidebar
  document.getElementById('api-dot').classList.toggle('ok', isOk);
  document.getElementById('api-status-text').classList.toggle('ok', isOk);
  document.getElementById('api-status-text').textContent = isOk ? 'API ì—°ê²°ë¨' : 'API ë¯¸ì„¤ì •';
  // Drawer
  var ddot  = document.getElementById('drawer-api-dot');
  var dtext = document.getElementById('drawer-api-text');
  if (ddot)  ddot.classList.toggle('ok', isOk);
  if (dtext) { dtext.classList.toggle('ok', isOk); dtext.textContent = isOk ? 'ì—°ê²°ë¨' : 'ë¯¸ì„¤ì •'; }
}

// â”€â”€ DRAWER â”€â”€
function openDrawer()  { document.getElementById('mobile-drawer').classList.add('open'); }
function closeDrawer() { document.getElementById('mobile-drawer').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(n) {
  document.querySelectorAll('.view').forEach(function(v){ v.classList.remove('active'); });
  document.querySelectorAll('.nav-btn').forEach(function(b){ b.classList.remove('active'); });
  document.querySelectorAll('.tab-item').forEach(function(t){ t.classList.remove('active'); });
  document.getElementById('view-' + n).classList.add('active');
  var nav = document.getElementById('nav-' + n);
  if (nav) nav.classList.add('active');
  var tab = document.getElementById('tab-' + n);
  if (tab) tab.classList.add('active');
  var titles = {prompt:'âš¡ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°', chat:'ğŸ’¬ AI ì±„íŒ…', image:'ğŸ¨ ì´ë¯¸ì§€ ìƒì„±'};
  document.getElementById('topbar-title').textContent = titles[n];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEMINI API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function callGemini(messages, sys, callback) {
  if (!apiKey) { showToast('âš  API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); callback(null); return; }
  var contents = messages.map(function(m) {
    return { role: m.role === 'assistant' ? 'model' : 'user', parts: m.parts || [{text: m.content}] };
  });
  var body = {contents: contents};
  if (sys) body.systemInstruction = {parts: [{text: sys}]};

  fetch('https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + apiKey, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  }).then(function(res){ return res.json(); }).then(function(data) {
    if (data.error) { showToast('âŒ ' + data.error.message); callback(null); return; }
    callback(data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : '');
  }).catch(function(e){ showToast('âŒ ' + e.message); callback(null); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROMPT GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var PSYS = 'ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ AI í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ AIë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ 3ê°€ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.\n\nê° í”„ë¡¬í”„íŠ¸ëŠ”: ëª…í™•í•œ ì—­í• /í˜ë¥´ì†Œë‚˜, êµ¬ì²´ì  ì§€ì‹œì‚¬í•­, ì¶œë ¥ í˜•ì‹ ëª…ì‹œ, ì˜ˆì‹œ/ì œì•½ì¡°ê±´ í¬í•¨.\n\në°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”:\n### í”„ë¡¬í”„íŠ¸ 1: [ìœ í˜•ëª…]\n[ë‚´ìš©]\n\n### í”„ë¡¬í”„íŠ¸ 2: [ìœ í˜•ëª…]\n[ë‚´ìš©]\n\n### í”„ë¡¬í”„íŠ¸ 3: [ìœ í˜•ëª…]\n[ë‚´ìš©]';

function generatePrompts() {
  var inp = document.getElementById('prompt-input').value.trim();
  if (!inp) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('gen-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner">âŸ³</span> ìƒì„± ì¤‘...';
  document.getElementById('prompt-results').innerHTML =
    '<div style="text-align:center;padding:40px;color:var(--text-muted)"><span class="spinner" style="font-size:26px">âŸ³</span><br><br>ìµœì  í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...</div>';

  callGemini([{role:'user', content:inp}], PSYS, function(res) {
    if (!res) res = demoPrompts(inp);
    btn.disabled = false;
    btn.innerHTML = 'âœ¦ ìƒì„±';
    renderResults(res);
  });
}

function demoPrompts(inp) {
  return '### í”„ë¡¬í”„íŠ¸ 1: ì „ë¬¸ê°€ í˜ë¥´ì†Œë‚˜\në‹¹ì‹ ì€ "' + inp + '" ë¶„ì•¼ì˜ 10ë…„ ì´ìƒ ê²½ë ¥ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì „ë¬¸ì ì´ê³  ì‹¤ìš©ì ì¸ ê´€ì ì—ì„œ ë‹¨ê³„ë³„ë¡œ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê° ë‹¨ê³„ë§ˆë‹¤ ì£¼ì˜ì‚¬í•­ê³¼ ì˜ˆì‹œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.\n\n### í”„ë¡¬í”„íŠ¸ 2: êµ¬ì¡°í™” ë¶„ì„\n"' + inp + '"ì— ëŒ€í•´ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:\n1. í•µì‹¬ ê°œë… (3ì¤„ ìš”ì•½)\n2. ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ\n3. ì£¼ì˜ì‚¬í•­ê³¼ ìì£¼ ë°œìƒí•˜ëŠ” ì‹¤ìˆ˜\n4. ì‹¬í™” í•™ìŠµ ì¶”ì²œ\n\nê° ì„¹ì…˜ì— ì‹¤ì œ ì˜ˆì‹œë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.\n\n### í”„ë¡¬í”„íŠ¸ 3: ëŒ€í™”í˜• ì½”ì¹˜\në‚˜ëŠ” "' + inp + '"ë¥¼ ì²˜ìŒ ì‹œì‘í•˜ëŠ” ì´ˆë³´ìì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë‹¹ì¥ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  ì•¡ì…˜ ì•„ì´í…œì„ ì œì‹œí•˜ê³  ìê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.';
}

function renderResults(text) {
  var sections = text.split(/###\s*í”„ë¡¬í”„íŠ¸\s*\d+[:\s]*/g).filter(function(s){ return s.trim(); });
  var labelMatches = text.match(/###\s*í”„ë¡¬í”„íŠ¸\s*\d+[:\s]*([^\n]+)/g) || [];
  var labels = labelMatches.map(function(m){ return m.replace(/###\s*í”„ë¡¬í”„íŠ¸\s*\d+[:\s]*/, '').trim(); });

  var el = document.getElementById('prompt-results');
  el.innerHTML = '<div class="results-grid" id="results-grid"></div>';
  var grid = document.getElementById('results-grid');

  sections.forEach(function(sec, i) {
    var card = document.createElement('div');
    card.className = 'result-card';
    var label = labels[i] || ('í”„ë¡¬í”„íŠ¸ ' + (i+1));
    var secText = sec.trim();

    var actionsDiv = document.createElement('div');
    actionsDiv.className = 'result-actions';

    var copyBtn = document.createElement('button');
    copyBtn.className = 'r-btn';
    copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
    copyBtn.addEventListener('click', function() {
      navigator.clipboard.writeText(secText).then(function() {
        copyBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
        setTimeout(function(){ copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬'; }, 1500);
      });
    });

    var useBtn = document.createElement('button');
    useBtn.className = 'r-btn use-btn';
    useBtn.textContent = 'ğŸ’¬ ì±„íŒ…';
    useBtn.addEventListener('click', function() {
      switchView('chat');
      document.getElementById('chat-input').value = secText;
      autoResize(document.getElementById('chat-input'));
      showToast('ì±„íŒ…ì°½ì— í”„ë¡¬í”„íŠ¸ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    });

    actionsDiv.appendChild(copyBtn);
    actionsDiv.appendChild(useBtn);

    card.innerHTML = '<div class="result-label">âœ¦ ' + label + '</div><div class="result-text">' + escapeHTML(secText) + '</div>';
    card.appendChild(actionsDiv);
    grid.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function quickPrompt(text) {
  switchView('chat');
  document.getElementById('chat-input').value = text;
  sendMessage();
}

function newChat() {
  if (chatHistory.length > 0) {
    var title = (chatHistory[0] && chatHistory[0].content) ? chatHistory[0].content.substring(0, 26) + 'â€¦' : 'ëŒ€í™”';
    chatSessions.unshift({id: Date.now(), title: title, history: chatHistory.slice()});
    if (chatSessions.length > 10) chatSessions.pop();
    saveFS({chatSessions: chatSessions});
    loadChatHistoryUI();
  }
  chatHistory = [];
  chatAtt = {files:[], images:[]};
  document.getElementById('chat-messages').innerHTML = chatWelcomeHTML();
  document.getElementById('chat-attachments').innerHTML = '';
}

function chatWelcomeHTML() {
  return '<div class="chat-welcome" id="chat-welcome"><h2>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2><p>Gemini AIì™€ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”.</p><div class="quick-prompts" id="quick-prompts"></div></div>';
}

function loadChatHistoryUI() {
  var lists = [
    {el: document.getElementById('chat-history'), isDrawer: false},
    {el: document.getElementById('drawer-chat-history'), isDrawer: true}
  ];
  lists.forEach(function(item) {
    if (!item.el) return;
    item.el.innerHTML = '';
    chatSessions.slice(0, 5).forEach(function(s) {
      var b = document.createElement('button');
      b.className = item.isDrawer ? 'drawer-btn' : 'chat-history-item';
      b.innerHTML = '<span>ğŸ’¬</span><span class="chat-title">' + escapeHTML(s.title) + '</span>';
      b.addEventListener('click', function() {
        if (item.isDrawer) closeDrawer();
        loadSession(s);
      });
      item.el.appendChild(b);
    });
  });

  // Re-attach quick prompts after newChat rewrites the DOM
  var qpEl = document.getElementById('quick-prompts');
  if (qpEl && qpEl.children.length === 0) {
    QUICK_PROMPTS.forEach(function(item2) {
      var btn = document.createElement('button');
      btn.className = 'qp-btn';
      btn.textContent = item2.icon + ' ' + item2.text.replace('ë¥¼ í•´ì¤˜','').replace('ì„ í•´ì¤˜','').replace(' ë„ì™€ì¤˜','').replace(' ì‘ì„±í•´ì¤˜','');
      btn.addEventListener('click', function(){ quickPrompt(item2.text); });
      qpEl.appendChild(btn);
    });
  }
}

function loadSession(s) {
  chatHistory = s.history.slice();
  var el = document.getElementById('chat-messages');
  el.innerHTML = '';
  chatHistory.forEach(function(m){ appendMsg(m.role, m.content, false); });
  switchView('chat');
  el.scrollTop = el.scrollHeight;
}

function sendMessage() {
  var inp  = document.getElementById('chat-input');
  var text = inp.value.trim();
  if (!text && !chatAtt.images.length && !chatAtt.files.length) return;

  var welcome = document.getElementById('chat-welcome');
  if (welcome) welcome.remove();
  document.getElementById('send-btn').disabled = true;

  var parts = [];
  var disp  = text;
  if (text) parts.push({text: text});

  chatAtt.images.forEach(function(img) {
    parts.push({inlineData: {mimeType: img.mimeType, data: img.data}});
    disp += (disp ? '\n' : '') + 'ğŸ–¼ [' + img.name + ']';
  });
  chatAtt.files.forEach(function(f) {
    parts.push({text: '\n\n[íŒŒì¼: ' + f.name + ']\n' + f.content});
    disp += (disp ? '\n' : '') + 'ğŸ“„ [' + f.name + ']';
  });

  appendMsg('user', disp);
  chatHistory.push({role:'user', content:disp, parts:parts});
  inp.value = ''; inp.style.height = 'auto';
  chatAtt = {files:[], images:[]};
  document.getElementById('chat-attachments').innerHTML = '';

  var typingId = showTyping();

  callGemini(chatHistory.map(function(m){
    return {role: m.role, parts: m.parts || [{text: m.content}]};
  }), '', function(resp) {
    removeTyping(typingId);
    if (resp) {
      appendMsg('assistant', resp);
      chatHistory.push({role:'assistant', content:resp, parts:[{text:resp}]});
    }
    document.getElementById('send-btn').disabled = false;
    var msgEl = document.getElementById('chat-messages');
    msgEl.scrollTop = msgEl.scrollHeight;
  });
}

function appendMsg(role, content, scroll) {
  if (scroll === undefined) scroll = true;
  var el  = document.getElementById('chat-messages');
  var d   = document.createElement('div');
  d.className = 'msg ' + role;
  var avHTML = role === 'user'
    ? (currentUser && currentUser.photoURL ? '<img src="' + currentUser.photoURL + '" alt="">' : ((currentUser && currentUser.displayName ? currentUser.displayName[0] : 'N').toUpperCase()))
    : 'âœ¦';
  d.innerHTML = '<div class="msg-avatar">' + avHTML + '</div><div class="msg-bubble">' + fmtMd(content) + '</div>';
  el.appendChild(d);
  if (scroll) el.scrollTop = el.scrollHeight;
}

function fmtMd(t) {
  return escapeHTML(t)
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code style="background:rgba(255,255,255,.1);padding:2px 5px;border-radius:4px;font-size:.9em">$1</code>')
    .replace(/\n/g, '<br>');
}

function showTyping() {
  var el = document.getElementById('chat-messages');
  var id = 't' + Date.now();
  var d  = document.createElement('div');
  d.className = 'msg assistant'; d.id = id;
  d.innerHTML = '<div class="msg-avatar">âœ¦</div><div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>';
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
  return id;
}
function removeTyping(id) {
  var el = document.getElementById(id);
  if (el) el.remove();
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleVoice() { isRecording ? stopRec() : startRec(); }
function startRec() {
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'); return; }
  recognition = new SR();
  recognition.lang = 'ko-KR'; recognition.continuous = false; recognition.interimResults = false;
  recognition.onresult = function(e) {
    var t = e.results[0][0].transcript;
    var inp = document.getElementById('chat-input');
    inp.value += (inp.value ? ' ' : '') + t;
    autoResize(inp);
  };
  recognition.onend = stopRec;
  recognition.onerror = stopRec;
  recognition.start();
  isRecording = true;
  document.getElementById('rec-indicator').classList.add('active');
  document.getElementById('voice-btn').textContent = 'â¹';
}
function stopRec() {
  if (recognition) recognition.stop();
  isRecording = false;
  document.getElementById('rec-indicator').classList.remove('active');
  document.getElementById('voice-btn').textContent = 'ğŸ¤';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE ATTACHMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function attachFile(inp, ctx) {
  var f = inp.files[0]; if (!f) return;
  var r = new FileReader();
  r.onload = function(e) {
    var o = {name: f.name, content: e.target.result};
    if (ctx === 'chat') { chatAtt.files.push(o); updateChatAttUI(); }
    else                { promptAtt.files.push(o); updatePromptAttUI(); }
    showToast('ğŸ“„ ' + f.name + ' ì²¨ë¶€ë¨');
  };
  r.readAsText(f); inp.value = '';
}
function attachImage(inp, ctx) {
  var f = inp.files[0]; if (!f) return;
  var r = new FileReader();
  r.onload = function(e) {
    var o = {name: f.name, data: e.target.result.split(',')[1], mimeType: f.type};
    if (ctx === 'chat') { chatAtt.images.push(o); updateChatAttUI(); }
    else                { promptAtt.images.push(o); updatePromptAttUI(); }
    showToast('ğŸ–¼ ' + f.name + ' ì²¨ë¶€ë¨');
  };
  r.readAsDataURL(f); inp.value = '';
}
function updateChatAttUI() {
  var el = document.getElementById('chat-attachments');
  el.innerHTML = '';
  var all = chatAtt.files.concat(chatAtt.images);
  all.forEach(function(f, i) {
    var d = document.createElement('div');
    d.className = 'attach-preview';
    var rm = document.createElement('span');
    rm.className = 'rm'; rm.textContent = 'âœ•';
    rm.addEventListener('click', function(){ removeChatAttach(i); });
    d.textContent = f.name + ' ';
    d.appendChild(rm);
    el.appendChild(d);
  });
}
function updatePromptAttUI() {
  var el = document.getElementById('attach-list');
  el.innerHTML = '';
  promptAtt.files.concat(promptAtt.images).forEach(function(f) {
    var s = document.createElement('span');
    s.className = 'file-chip'; s.textContent = 'ğŸ“ ' + f.name;
    el.appendChild(s);
  });
}
function removeChatAttach(i) {
  var all  = chatAtt.files.concat(chatAtt.images);
  var item = all[i];
  chatAtt.files   = chatAtt.files.filter(function(f){ return f !== item; });
  chatAtt.images  = chatAtt.images.filter(function(f){ return f !== item; });
  updateChatAttUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateImage() {
  var p = document.getElementById('image-prompt-input').value.trim();
  if (!p) { showToast('ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!apiKey) { showToast('âš  API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
  showToast('ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
  var full = imageStyle ? imageStyle + ': ' + p : p;
  fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + apiKey, {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({contents:[{parts:[{text:full}]}], generationConfig:{responseModalities:['Text','Image']}})
  }).then(function(res){ return res.json(); }).then(function(data) {
    var parts = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts;
    var img   = parts && parts.find(function(x){ return x.inlineData; });
    if (img) {
      document.getElementById('image-results').innerHTML =
        '<img src="data:' + img.inlineData.mimeType + ';base64,' + img.inlineData.data + '" style="width:100%;border-radius:12px;border:1px solid var(--border)">';
    } else {
      showToast('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨. gemini-2.0-flash ëª¨ë¸ì„ ì„ íƒí•´ë³´ì„¸ìš”.');
    }
  }).catch(function(e){ showToast('âŒ ' + e.message); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2600);
}

function escapeHTML(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function googleBtnHTML() {
  return '<svg viewBox="0 0 24 24" style="width:20px;height:20px;flex-shrink:0"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°';
}

function getAuthErrMsg(code) {
  var msgs = {
    'auth/popup-closed-by-user':  'ë¡œê·¸ì¸ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
    'auth/popup-blocked':         'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.',
    'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.',
    'auth/unauthorized-domain':   'Firebaseì— ë„ë©”ì¸ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nFirebase ì½˜ì†” > Authentication > Settings > Authorized domainsì—ì„œ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.'
  };
  return msgs[code] || ('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + code);
}
</script>
</body>
</html>
